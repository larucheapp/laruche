<!DOCTYPE html>
<html lang="fr" data-app="laruche">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Créateur de Graphiques</title>
  <meta name="description" content="Créez des graphiques de visualisation de données (barres, lignes, circulaires) et exportez-les en PNG ou PDF.">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
  
  <style>
    :root{
      --color-bg:#FFFFFF;
      --color-bg-alt:#F7F8FA;
      --color-border:#E9EAF0;
      --color-text-primary:#141417;
      --color-text-secondary:#6B7280;
      --color-violet:#7C3AED;
      --color-violet-dark:#6D28D9;
      --radius-md:12px;
      --radius-lg:14px;
      --tool-max-w:480px;
    }

    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{height:100%;background-color:var(--color-bg)}
    body{
      height:100vh; overflow:hidden; display:flex; flex-direction:column;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Inter",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--color-text-primary); line-height:1.5; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body[data-size="default"]{--tool-max-w:480px}
    body[data-size="wide"]{--tool-max-w:960px}
    body[data-size="xl"]{--tool-max-w:1200px}

    #bg-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:-1}

    .app-header{
      flex-shrink:0; background:var(--color-bg-alt); border-bottom:1px solid var(--color-border);
      padding:0 24px; display:flex; align-items:center; height:70px;
    }
    .app-header a{display:inline-flex; align-items:center}
    .logo-img{height:70px; width:auto; vertical-align:middle}

    .main-content{
      flex-grow:1; display:flex; justify-content:center;
      padding:24px; overflow-y:auto;
    }
    .tool-wrapper{
      display:flex; flex-direction:column; align-items:center; position:relative; 
      width: 100%; margin-top: 30px;
    }
    .tool-title{
      font-size:1.75rem; font-weight:600; padding:12px 28px;
      background:linear-gradient(45deg,var(--color-violet),var(--color-violet-dark));
      color:#fff; border-radius:var(--radius-md); margin-bottom:-20px; position:relative; z-index:5;
      box-shadow:0 4px 14px -4px rgba(124,58,237,.4);
    }
    .generator-card{
      background:var(--color-bg); border:1px solid var(--color-border); border-radius:var(--radius-lg);
      padding:28px; padding-top:40px; width:100%; max-width:var(--tool-max-w);
      box-shadow:0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      display:flex; flex-direction:column; gap:24px;
    }
    .form-group{display:flex; flex-direction:column; gap:8px}
    .form-label{font-weight:500; color:var(--color-text-primary)}
    .form-input {
      width:100%; padding:10px 14px; border:1px solid var(--color-border); border-radius:var(--radius-md);
      font-size:1rem; color:var(--color-text-primary); background:var(--color-bg);
      transition:border-color .2s, box-shadow .2s;
    }
    .form-input:focus {
        outline:none; border-color:var(--color-violet); box-shadow:0 0 0 3px rgba(124,58,237,.2)
    }
    .actions{display:flex; justify-content:flex-end; gap:12px; flex-wrap: wrap;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      font-weight:500; padding:10px 16px; border-radius:var(--radius-md); border:none; cursor:pointer;
      transition:background-color .2s, box-shadow .2s, color .2s; font-size:14px;
    }
    .btn:focus-visible{outline:2px solid transparent; outline-offset:2px; box-shadow:0 0 0 3px rgba(124,58,237,.4)}
    .btn-primary{background:var(--color-violet); color:#fff}
    .btn-primary:hover:not(:disabled){background:var(--color-violet-dark)}
    .btn-primary:disabled{background:#A78BFA; cursor:not-allowed}
    .btn-secondary {
      background: var(--color-bg-alt); color: var(--color-text-secondary); border: 1px solid var(--color-border);
    }
    .btn-secondary:hover:not(:disabled) { background: #F0F1F3; }
    .btn-icon {
      padding: 6px; background: transparent; color: var(--color-text-secondary); flex-shrink: 0;
    }
    .btn-icon:hover { background: var(--color-bg-alt); color: #DC2626; } /* red-600 */
    .status-text{font-size:14px; color:var(--color-text-secondary); text-align:center; min-height:42px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 12px;}
    
    .chart-layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
      width: 100%;
      max-width: var(--tool-max-w);
      justify-items: center;
    }
    .chart-layout > .generator-card[role="form"] {
      width: 100%;
      max-width: 720px;
    }
    @media (max-width: 1024px) {
      .chart-layout { 
        gap: 24px;
      }
    }

    #chart-container {
      padding: 28px; display: flex; align-items: center; justify-content: center; min-height: 400px; position: relative;
    }
    .data-section { border-top: 1px solid var(--color-border); padding-top: 16px; }
    .data-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 12px; }
    
    .chart-type-selector { display: flex; flex-wrap: wrap; gap: 8px; }
    .chart-type-selector .btn { flex-grow: 1; }
    .chart-type-selector .btn.active {
      background: var(--color-violet); color: #fff;
      box-shadow: 0 2px 8px -2px rgba(124,58,237,.4);
    }

    .data-grid { display: grid; gap: 8px; align-items: center; }
    .data-grid-header { display: contents; }
    .data-grid-row { display: contents; }
    .grid-header-cell {
        font-weight: 500; color: var(--color-text-secondary); font-size: 14px;
        text-align: center; display: flex; align-items: center; gap: 4px;
    }
    .grid-header-cell .form-input { text-align: center; }
    .data-grid-actions { display: flex; gap: 8px; margin-top: 12px; }
    
    .pro-option-toggle {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 10px 14px; border-radius: var(--radius-md); border: 1px solid var(--color-border);
        cursor: pointer; transition: border-color .2s, box-shadow .2s; user-select: none;
    }
    .pro-option-toggle:hover { border-color: #D1D5DB; }
    
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    .pro-option-toggle .pro-badge {
        font-size: 10px; font-weight: 600; padding: 2px 6px;
        background: var(--color-violet-dark); color: #fff;
        border-radius: 6px; letter-spacing: 0.5px;
    }
    .pro-option-toggle svg { color: var(--color-text-secondary); transition: color .2s; }
    input.visually-hidden:checked + .pro-option-toggle {
        border-color: var(--color-violet);
        box-shadow: 0 0 0 3px rgba(124,58,237,.2);
    }
    input.visually-hidden:checked + .pro-option-toggle svg { color: var(--color-violet); }

  </style>
</head>
<body data-size="wide">
  <canvas id="bg-canvas"></canvas>

  <header class="app-header">
    <a href="index.html" aria-label="Accueil">
      <img src="logo-2.png" alt="Logo La Ruche" class="logo-img">
    </a>
  </header>

  <main class="main-content">
    <div class="tool-wrapper">
      <h1 class="tool-title">Créateur de Graphiques</h1>
      
      <div class="chart-layout">
        <div class="generator-card" role="form" aria-label="Configuration du graphique">
          <div class="form-group">
            <label for="chart-title" class="form-label">Titre du graphique</label>
            <input type="text" id="chart-title" class="form-input" placeholder="Ex: Ventes par trimestre">
          </div>
          <div class="form-group">
            <label class="form-label">Type de graphique</label>
            <div id="chart-type-selector" class="chart-type-selector" role="radiogroup" aria-label="Type de graphique"></div>
          </div>
          
          <div class="form-group">
              <input type="checkbox" id="multicolor-toggle" class="visually-hidden">
              <label for="multicolor-toggle" class="pro-option-toggle" role="switch" aria-checked="false" title="Activer les couleurs PRO">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.34 0 .68-.02 1.01-.06"/><path d="M22 12c0-5.52-4.48-10-10-10"/><path d="M12 12c0 5.52 4.48 10 10 10"/><path d="M12 12c-5.52 0-10 4.48-10 10"/><path d="M12 12c5.52 0 10-4.48 10-10"/></svg>
                  <span class="pro-badge">PRO</span>
              </label>
          </div>

          <div class="data-section">
            <h3 class="data-section-title">Données du Graphique</h3>
            <div id="data-grid-container"></div>
            <div class="data-grid-actions">
                <button id="add-label-btn" class="btn btn-secondary">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                  Ajouter une ligne
                </button>
                <button id="add-series-btn" class="btn btn-secondary">
                   <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                  Ajouter une colonne
                </button>
            </div>
          </div>
        </div>
        
        <div class="generator-card" role="region" aria-label="Aperçu du graphique">
            <div id="chart-container">
                <canvas id="chart-canvas"></canvas>
            </div>
            <div class="actions">
                <button id="export-png-btn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Exporter en PNG
                </button>
                <button id="export-pdf-btn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    Exporter en PDF
                </button>
            </div>
             <p class="status-text" id="status-text" role="status" aria-live="polite">Prêt.</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function(){
      const c = document.getElementById('bg-canvas');
      const ctx = c.getContext('2d');
      function draw(){
        const dpr = window.devicePixelRatio || 1;
        const rect = c.getBoundingClientRect();
        c.width = rect.width * dpr; c.height = rect.height * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,rect.width,rect.height);
        const size = 24, hexW = 2 * size, hexH = Math.sqrt(3) * size, stepX = hexW * 3/4;
        ctx.strokeStyle = 'rgba(124,58,237,0.10)'; ctx.lineWidth = 1;
        for(let row=0; row*hexH < rect.height + hexH; row++){
          for(let col=0; col*stepX < rect.width + hexW; col++){
            const x = col * stepX, y = row * hexH + (col % 2 ? hexH/2 : 0);
            ctx.beginPath();
            for(let i=0;i<6;i++){
              const a = 2 * Math.PI / 6 * i;
              const px = x + size * Math.cos(a), py = y + size * Math.sin(a);
              if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
            }
            ctx.closePath(); ctx.stroke();
          }
        }
      }
      window.addEventListener('resize', draw, {passive:true});
      draw();
    })();

    document.addEventListener('DOMContentLoaded', () => {
        const chartTypeSelector = document.getElementById('chart-type-selector');
        const chartTitleInput = document.getElementById('chart-title');
        const dataGridContainer = document.getElementById('data-grid-container');
        const addLabelBtn = document.getElementById('add-label-btn');
        const addSeriesBtn = document.getElementById('add-series-btn');
        const exportPngBtn = document.getElementById('export-png-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const statusText = document.getElementById('status-text');
        const chartCanvas = document.getElementById('chart-canvas').getContext('2d');
        const multicolorToggle = document.getElementById('multicolor-toggle');
        
        const MAX_LABELS = 70;
        const MAX_SERIES = 7;

        Chart.register({
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart, args, options) => {
                const { ctx } = chart;
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = options.backgroundColor || '#fff';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        });

        let chartInstance = null;
        let currentChartType = 'bar';
        let isMulticolorEnabled = false;
        let chartData = {
            labels: ['Trimestre 1', 'Trimestre 2', 'Trimestre 3', 'Trimestre 4'],
            datasets: [{ label: 'Ventes 2023', data: [500, 750, 600, 900] }]
        };

        const CHART_TYPES = {
            bar: "Barres", line: "Ligne", pie: "Circulaire", doughnut: "Donut",
        };
        const SINGLE_SERIES_CHARTS = ['pie', 'doughnut'];
        
        const renderUI = () => {
            const isSingleSeries = SINGLE_SERIES_CHARTS.includes(currentChartType);
            if (isSingleSeries && chartData.datasets.length > 1) {
                chartData.datasets = [chartData.datasets[0]];
            }
            addSeriesBtn.style.display = isSingleSeries ? 'none' : 'flex';
            
            chartTypeSelector.querySelectorAll('.btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === currentChartType);
            });

            dataGridContainer.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'data-grid';
            const numCols = chartData.datasets.length + 2; 
            grid.style.gridTemplateColumns = `minmax(120px, 1.5fr) repeat(${chartData.datasets.length}, 1fr) auto`;
            
            const header = document.createElement('div');
            header.className = 'data-grid-header';
            header.innerHTML = `<div class="grid-header-cell">Étiquettes</div>`;
            chartData.datasets.forEach((ds, seriesIndex) => {
                const cell = document.createElement('div');
                cell.className = 'grid-header-cell';
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-input';
                input.value = ds.label;
                input.dataset.seriesIndex = seriesIndex;
                input.placeholder = `Série ${seriesIndex + 1}`;
                cell.appendChild(input);
                if (!isSingleSeries) {
                    const removeBtn = createRemoveButton(() => removeSeries(seriesIndex));
                    cell.appendChild(removeBtn);
                }
                header.appendChild(cell);
            });
            header.appendChild(document.createElement('div'));
            grid.appendChild(header);

            chartData.labels.forEach((label, labelIndex) => {
                const row = document.createElement('div');
                row.className = 'data-grid-row';
                row.innerHTML = `
                    <input type="text" class="form-input label-input" value="${label}" data-label-index="${labelIndex}">
                    ${chartData.datasets.map((ds, seriesIndex) => `
                        <input type="number" class="form-input value-input" value="${ds.data[labelIndex] || 0}" data-label-index="${labelIndex}" data-series-index="${seriesIndex}">
                    `).join('')}
                `;
                const actionCell = document.createElement('div');
                actionCell.appendChild(createRemoveButton(() => removeLabel(labelIndex)));
                row.appendChild(actionCell);
                grid.appendChild(row);
            });

            dataGridContainer.appendChild(grid);

            addLabelBtn.disabled = chartData.labels.length >= MAX_LABELS;
            addSeriesBtn.disabled = chartData.datasets.length >= MAX_SERIES;
        };
        
        const createRemoveButton = (onClick) => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-icon';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
            btn.addEventListener('click', onClick);
            return btn;
        };

        const renderChart = () => {
            if (chartInstance) chartInstance.destroy();
            const title = chartTitleInput.value || "Mon Graphique";
            
            const monoColors = ['#7C3AED', '#A78BFA', '#6D28D9', '#C4B5FD', '#5B21B6', '#8B5CF6'];
            const proColors = [ '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#D946EF'];
            const activeColors = isMulticolorEnabled ? proColors : monoColors;
            
            const datasets = chartData.datasets.map((ds, index) => ({
                label: ds.label,
                data: ds.data,
                backgroundColor: currentChartType === 'line' ? 'transparent' : (SINGLE_SERIES_CHARTS.includes(currentChartType) ? activeColors : activeColors[index % activeColors.length]),
                borderColor: activeColors[index % activeColors.length],
                borderWidth: currentChartType === 'line' ? 2 : 1,
                pointBackgroundColor: activeColors[index % activeColors.length],
                tension: 0.1
            }));

            chartInstance = new Chart(chartCanvas, {
                type: currentChartType,
                data: { labels: chartData.labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: !SINGLE_SERIES_CHARTS.includes(currentChartType) && chartData.datasets.length > 1 },
                        title: { display: true, text: title, font: { size: 16 }, color: 'var(--color-text-primary)', padding: { bottom: 20 } },
                        customCanvasBackgroundColor: {
                           backgroundColor: 'white',
                        }
                    },
                    scales: (currentChartType === 'bar' || currentChartType === 'line') ? { y: { beginAtZero: true } } : {}
                }
            });
            statusText.textContent = "Prêt.";
        };

        const updateAndRender = () => { renderUI(); renderChart(); };

        const removeLabel = (index) => {
            chartData.labels.splice(index, 1);
            chartData.datasets.forEach(ds => ds.data.splice(index, 1));
            updateAndRender();
        };

        const removeSeries = (index) => {
            chartData.datasets.splice(index, 1);
            updateAndRender();
        };

        dataGridContainer.addEventListener('input', (e) => {
            if (e.target.matches('.label-input')) {
                const index = parseInt(e.target.dataset.labelIndex, 10);
                chartData.labels[index] = e.target.value;
            } else if (e.target.matches('.value-input')) {
                const labelIndex = parseInt(e.target.dataset.labelIndex, 10);
                const seriesIndex = parseInt(e.target.dataset.seriesIndex, 10);
                chartData.datasets[seriesIndex].data[labelIndex] = parseFloat(e.target.value) || 0;
            } else if (e.target.matches('.form-input')) { 
                const seriesIndex = parseInt(e.target.dataset.seriesIndex, 10);
                chartData.datasets[seriesIndex].label = e.target.value;
            }
            renderChart();
        });

        addLabelBtn.addEventListener('click', () => {
            if (chartData.labels.length >= MAX_LABELS) return;
            chartData.labels.push(`Ligne ${chartData.labels.length + 1}`);
            chartData.datasets.forEach(ds => ds.data.push(0));
            updateAndRender();
        });

        addSeriesBtn.addEventListener('click', () => {
            if (chartData.datasets.length >= MAX_SERIES) return;
            const newSeriesData = Array(chartData.labels.length).fill(0);
            chartData.datasets.push({
                label: `Colonne ${chartData.datasets.length + 1}`,
                data: newSeriesData
            });
            updateAndRender();
        });

        chartTitleInput.addEventListener('input', renderChart);
        
        multicolorToggle.addEventListener('change', (e) => {
            isMulticolorEnabled = e.target.checked;
            e.target.nextElementSibling.setAttribute('aria-checked', isMulticolorEnabled);
            renderChart();
        });

        const showDownloadLink = (href, filename) => {
            const link = document.createElement('a');
            link.href = href;
            link.download = filename;
            link.textContent = `Télécharger ${filename}`;
            link.classList.add('btn', 'btn-primary');
            link.style.textDecoration = 'none';

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Fermer';
            closeBtn.className = 'btn btn-secondary';
            closeBtn.onclick = () => {
                statusText.innerHTML = 'Prêt.';
            };

            statusText.innerHTML = '';
            statusText.appendChild(link);
            statusText.appendChild(closeBtn);
        };

        const exportChart = (format) => {
            if (!chartInstance) {
                statusText.textContent = "Aucun graphique à exporter.";
                return;
            }
            statusText.innerHTML = `Génération de votre fichier ${format.toUpperCase()}...`;
            
            setTimeout(() => {
                try {
                    const title = (chartTitleInput.value || 'graphique').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    
                    if (format === 'png') {
                        const originalBgColor = chartInstance.options.plugins.customCanvasBackgroundColor.backgroundColor;
                        chartInstance.options.plugins.customCanvasBackgroundColor.backgroundColor = 'transparent';
                        chartInstance.update('none');

                        const base64Image = chartInstance.canvas.toDataURL('image/png', 1.0);
                        
                        chartInstance.options.plugins.customCanvasBackgroundColor.backgroundColor = originalBgColor;
                        chartInstance.update('none'); 

                        if (!base64Image || base64Image === 'data:,') {
                            throw new Error("L'image générée est vide.");
                        }
                        showDownloadLink(base64Image, `${title}.png`);

                    } else if (format === 'pdf') {
                        const base64Image = chartInstance.canvas.toDataURL('image/png', 1.0);

                        if (!base64Image || base64Image === 'data:,') {
                            throw new Error("L'image générée est vide.");
                        }

                        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                           throw new Error("La librairie PDF n'est pas chargée.");
                        }
                        
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        
                        const PAGE_WIDTH = doc.internal.pageSize.getWidth();
                        const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
                        const MARGIN = 15;
                        const CONTENT_WIDTH = PAGE_WIDTH - MARGIN * 2;
                        
                        doc.setFillColor('#7C3AED');
                        doc.rect(0, 0, PAGE_WIDTH, 25, 'F');
                        doc.setFontSize(10);
                        doc.setTextColor('#FFFFFF');
                        doc.setFont('helvetica', 'normal');
                        doc.text('Rapport de Visualisation', MARGIN, 15);
                        const dateStr = new Date().toLocaleDateString('fr-FR');
                        doc.text(`Généré le ${dateStr}`, PAGE_WIDTH - MARGIN, 15, { align: 'right' });

                        let currentY = 40;

                        doc.setFontSize(18);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor('#141417');
                        const chartTitle = chartTitleInput.value || "Mon Graphique";
                        const splitTitle = doc.splitTextToSize(chartTitle, CONTENT_WIDTH);
                        doc.text(splitTitle, PAGE_WIDTH / 2, currentY, { align: 'center' });
                        currentY += (splitTitle.length * 7) + 10;

                        const { width: chartWidth, height: chartHeight } = chartInstance.canvas;
                        const chartAspectRatio = chartWidth / chartHeight;
                        let imgWidth = CONTENT_WIDTH;
                        let imgHeight = imgWidth / chartAspectRatio;
                        const maxImgHeight = 120;
                        if (imgHeight > maxImgHeight) {
                            imgHeight = maxImgHeight;
                            imgWidth = imgHeight * chartAspectRatio;
                        }
                        const imgX = (PAGE_WIDTH - imgWidth) / 2;
                        doc.addImage(base64Image, 'PNG', imgX, currentY, imgWidth, imgHeight);
                        currentY += imgHeight + 15;
                        
                        if (window.jspdf.autoTable) {
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor('#141417');
                            doc.text('Données brutes', MARGIN, currentY);
                            currentY += 8;

                            const head = [['Étiquette', ...chartData.datasets.map(ds => ds.label)]];
                            const body = chartData.labels.map((label, i) => {
                                return [label, ...chartData.datasets.map(ds => ds.data[i] ?? '')];
                            });

                            doc.autoTable({
                                startY: currentY,
                                head: head,
                                body: body,
                                theme: 'grid',
                                headStyles: {
                                    fillColor: '#6D28D9',
                                    textColor: '#FFFFFF',
                                    fontStyle: 'bold'
                                },
                                alternateRowStyles: {
                                    fillColor: '#F7F8FA'
                                },
                                styles: {
                                    font: 'helvetica',
                                    fontSize: 9,
                                    cellPadding: 2.5
                                },
                                margin: { left: MARGIN, right: MARGIN },
                            });
                        }

                        doc.setFillColor('#7C3AED');
                        doc.rect(0, PAGE_HEIGHT - 15, PAGE_WIDTH, 15, 'F');
                        doc.setFontSize(8);
                        doc.setTextColor('#FFFFFF');
                        doc.setFont('helvetica', 'normal');
                        doc.text("Généré avec le Créateur de Graphiques par La Ruche", PAGE_WIDTH / 2, PAGE_HEIGHT - 6.5, { align: 'center' });
                        
                        const pdfDataUri = doc.output('datauristring');
                        showDownloadLink(pdfDataUri, `${title}.pdf`);
                    }
                } catch (error) {
                    console.error("Erreur d'exportation:", error);
                    statusText.textContent = `Erreur : ${error.message || 'inconnue'}`;
                }
            }, 100);
        };
        
        exportPngBtn.addEventListener('click', () => exportChart('png'));
        exportPdfBtn.addEventListener('click', () => exportChart('pdf'));

        Object.entries(CHART_TYPES).forEach(([key, name]) => {
            const button = document.createElement('button');
            button.className = 'btn btn-secondary';
            button.textContent = name;
            button.dataset.type = key;
            button.setAttribute('role', 'radio');
            button.setAttribute('aria-checked', key === currentChartType);
            button.addEventListener('click', () => {
                currentChartType = key;
                button.setAttribute('aria-checked', true);
                updateAndRender();
            });
            chartTypeSelector.appendChild(button);
        });
        
        chartTitleInput.value = "Ventes par trimestre";
        updateAndRender();
    });
  </script>
</body>
</html>