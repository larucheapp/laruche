<!DOCTYPE html>
<html lang="fr" data-app="laruche">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apis Image — Générateur Média — La Ruche</title>
  <meta name="description" content="Discutez avec Apis pour qu'il vous 'génère' des images et vidéos uniques depuis la banque Pexels.">
  <style>
    :root {
      --color-bg: #FFFFFF;
      --color-bg-alt: #F7F8FA;
      --color-border: #E9EAF0;
      --color-text-primary: #141417;
      --color-text-secondary: #6B7280;
      --color-violet: #7C3AED;
      --color-violet-dark: #6D28D9;
      --radius-md: 12px;
      --radius-lg: 14px;
      --tool-max-w: 480px; /* par défaut, peut être changé via body[data-size] */
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; background-color: var(--color-bg); }
    body {
      height: 100vh; overflow: hidden; display: flex; flex-direction: column;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--color-text-primary); line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    body[data-size="default"] { --tool-max-w: 480px; }
    body[data-size="wide"] { --tool-max-w: 960px; }
    body[data-size="xl"] { --tool-max-w: 1200px; }

    #bg-canvas { position: fixed; inset: 0; width: 100%; height: 100%; z-index: -1; }

    .app-header {
      flex-shrink: 0; background: var(--color-bg-alt); border-bottom: 1px solid var(--color-border);
      padding: 0 24px; display: flex; align-items: center; height: 70px;
    }
    .app-header a { display: inline-flex; align-items: center; }
    .logo-img { height: 70px; width: auto; vertical-align: middle; }

    .main-content {
      flex-grow: 1; display: flex; align-items: center; justify-content: center;
      padding: 48px 24px; overflow-y: auto;
    }
    .tool-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; width: 100%; max-width: var(--tool-max-w); }
    .tool-title {
      font-size: 1.75rem; font-weight: 600; padding: 12px 28px;
      background: linear-gradient(45deg, var(--color-violet), var(--color-violet-dark));
      color: #fff; border-radius: var(--radius-md); margin-bottom: -20px; position: relative; z-index: 5;
      box-shadow: 0 4px 14px -4px rgba(124, 58, 237, .4);
    }
    .generator-card {
      background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-lg);
      width: 100%;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 70vh;
      max-height: 700px;
      margin-top: 20px;
    }
    .form-input {
      width: 100%; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md);
      font-size: 1rem; color: var(--color-text-primary); background: var(--color-bg);
      transition: border-color .2s, box-shadow .2s;
    }
    .form-input:focus { outline: none; border-color: var(--color-violet); box-shadow: 0 0 0 3px rgba(124, 58, 237, .2); }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      font-weight: 500; padding: 10px 16px; border-radius: var(--radius-md); border: none; cursor: pointer;
      transition: background-color .2s, box-shadow .2s, opacity .2s; font-size: 14px;
    }
    .btn:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 3px rgba(124, 58, 237, .4); }
    .btn-primary { background: var(--color-violet); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--color-violet-dark); }
    .btn-primary:disabled { background: #A78BFA; cursor: not-allowed; }

    /* Chat styles */
    .chat-history {
      flex-grow: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px;
    }
    .message { display: flex; max-width: 85%; align-items: flex-start; gap: 12px; }
    .message-avatar {
      flex-shrink: 0; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 16px;
    }
    .assistant-message .message-avatar { background-color: var(--color-border); overflow: hidden; }
    .assistant-message .message-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .assistant-message .message-avatar.fallback { background: linear-gradient(45deg, var(--color-violet), var(--color-violet-dark)); color: white; }
    .message-content { padding: 12px 16px; border-radius: var(--radius-lg); line-height: 1.6; word-break: break-word; }
    .assistant-message .message-content { background: var(--color-bg-alt); border: 1px solid var(--color-border); color: var(--color-text-primary); border-top-left-radius: 4px; }
    .user-message { align-self: flex-end; flex-direction: row-reverse; }
    .user-message .message-content { background: var(--color-violet); color: white; border-top-right-radius: 4px; }
    .message-content p:last-child { margin-bottom: 0; }
    
    .prompt-form-wrapper { padding: 16px 24px; border-top: 1px solid var(--color-border); background: var(--color-bg); border-bottom-left-radius: var(--radius-lg); border-bottom-right-radius: var(--radius-lg); flex-shrink: 0; }
    .prompt-form { display: flex; gap: 12px; align-items: center; }
    #send-btn { width: 42px; height: 42px; padding: 0; flex-shrink: 0; }
    
    /* Media message styles */
    .media-placeholder {
      width: 100%;
      aspect-ratio: 16 / 9;
      background-color: var(--color-bg-alt);
      border-radius: var(--radius-md);
      overflow: hidden;
      position: relative;
      background: #eee;
    }
    .loading-shimmer::after {
      content: ''; position: absolute; inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .4), transparent);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }

    .media-container {
      background-color: #000;
      border-radius: var(--radius-md);
      position: relative;
      overflow: hidden;
      line-height: 0;
    }
    .media-container:hover .media-overlay { opacity: 1; }
    .media-container img, .media-container video {
      width: 100%; height: auto; display: block;
    }
    .media-overlay {
      position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
      display: flex; justify-content: space-between; align-items: flex-end;
      padding: 12px; opacity: 0; transition: opacity .3s;
    }
    .photographer-credit { font-size: 13px; color: white; text-decoration: none; }
    .photographer-credit:hover { text-decoration: underline; }
    .download-btn {
      background: rgba(255,255,255,0.9); color: #000; border-radius: 8px; padding: 8px;
      line-height: 0; backdrop-filter: blur(4px);
    }
    .download-btn:hover { background: white; }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body data-size="wide">
  <canvas id="bg-canvas"></canvas>

  <header class="app-header">
    <a href="/" aria-label="Accueil">
      <img src="logo.png" alt="Logo La Ruche" class="logo-img">
    </a>
  </header>

  <main class="main-content">
    <div class="tool-wrapper">
      <h1 class="tool-title">Apis Image</h1>

      <div class="generator-card" role="region" aria-label="Générateur d'images Apis">
        <div id="chat-history" class="chat-history" role="log" aria-live="polite">
          <!-- Les messages seront ajoutés ici dynamiquement -->
        </div>
        <div class="prompt-form-wrapper">
          <form id="prompt-form" class="prompt-form">
            <input type="text" id="prompt-input" class="form-input" placeholder="Décrivez l'image ou la vidéo souhaitée..." autocomplete="off" required>
            <button id="send-btn" class="btn btn-primary" type="submit" aria-label="Envoyer">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/></svg>
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    const PEXELS_API_KEY = 'GckQdbK9Nh5aBvlnM6hnyGIs1aUZtPImGJTEKzpPb1VoXnRhk1tjtxvY';

    const chatHistory = document.getElementById('chat-history');
    const promptForm = document.getElementById('prompt-form');
    const promptInput = document.getElementById('prompt-input');
    
    let lastSuccessfulSearch = { query: '', type: 'photos' };

    const addMessage = (sender, content) => {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message ${sender}-message`;

        const avatarHtml = sender === 'assistant' ? `<div class="message-avatar"><img src="apis.png" alt="Avatar d'Apis" onerror="const p = this.parentElement; p.innerHTML = 'A'; p.classList.add('fallback');"></div>` : '';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        if (typeof content === 'string') {
          messageContent.innerHTML = `<p>${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
        } else {
          messageContent.appendChild(content);
        }

        if (sender === 'assistant' && typeof content !== 'string') {
            messageContent.style.padding = '0';
            messageContent.style.background = 'none';
            messageContent.style.border = 'none';
            messageContent.style.width = '100%';
        }
        
        messageWrapper.innerHTML = avatarHtml;
        messageWrapper.appendChild(messageContent);
        chatHistory.appendChild(messageWrapper);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return messageWrapper;
    };

    const parsePrompt = (text) => {
      const lowerText = text.toLowerCase();
      const isNegative = /\b(non|aime pas|autre|encore|mauvais|nul)\b/.test(lowerText);
      if (isNegative && lastSuccessfulSearch.query) {
        return { ...lastSuccessfulSearch, isContinuation: true };
      }

      const type = /\b(vidéo|film|clip)\b/.test(lowerText) ? 'videos' : 'photos';
      const cleanQuery = lowerText
        .replace(/\b(une?|le|la|les|de|des|du|d'|l'|montre-moi|je veux|cherche|trouve|génère|une image|une vidéo)\b/g, '')
        .replace(/[,.!?]/g, '')
        .trim();
      return { query: cleanQuery || 'nature', type, isContinuation: false };
    };
    
    const fetchFromPexels = async (query, type = 'photos') => {
      const endpoint = type === 'photos' 
        ? `https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=15&page=${Math.floor(Math.random()*5+1)}`
        : `https://api.pexels.com/v1/videos/search?query=${encodeURIComponent(query)}&per_page=15&page=${Math.floor(Math.random()*5+1)}`;

      try {
        const response = await fetch(endpoint, {
          headers: { Authorization: PEXELS_API_KEY }
        });
        if (!response.ok) throw new Error(`Pexels API error: ${response.statusText}`);
        const data = await response.json();
        const results = data.photos || data.videos;
        if (results && results.length > 0) {
          lastSuccessfulSearch = { query, type };
          return results[Math.floor(Math.random() * results.length)];
        }
        return null;
      } catch (error) {
        console.error(error);
        return null;
      }
    };
    
    const createMediaElement = (result, type) => {
      const container = document.createElement('div');
      container.className = 'media-container';

      const media = type === 'photos' ? document.createElement('img') : document.createElement('video');
      const sourceUrl = type === 'photos' ? result.src.large : result.video_files.find(f => f.quality === 'hd')?.link;
      const downloadUrl = type === 'photos' ? result.src.original : sourceUrl;

      media.src = sourceUrl;
      if (type === 'videos') {
          media.controls = true;
          media.autoplay = true;
          media.muted = true;
          media.loop = true;
      }
      media.alt = result.alt || `Média généré pour ${result.photographer}`;
      
      const overlay = document.createElement('div');
      overlay.className = 'media-overlay';
      overlay.innerHTML = `
        <a href="${result.photographer_url}" target="_blank" rel="noopener noreferrer" class="photographer-credit">Par ${result.photographer}</a>
        <button class="btn download-btn" aria-label="Télécharger le média"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 1.5a.75.75 0 01.75.75V12h3.44l-4.19 4.19a.75.75 0 01-1.06 0L6.75 12h3.5V2.25A.75.75 0 0112 1.5zM3.75 16.5a.75.75 0 01.75.75v3c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75v-3a.75.75 0 011.5 0v3A2.25 2.25 0 0118.75 22.5H5.25A2.25 2.25 0 013 20.25v-3a.75.75 0 01.75-.75z"/></svg></button>
      `;
      
      overlay.querySelector('.download-btn').addEventListener('click', async (e) => {
        e.currentTarget.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18" class="animate-spin"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.456 5.5 5.5 0 018.917 4.727l.284.025A.75.75 0 0115.312 11.424zM4.688 11.424a5.5 5.5 0 019.201-4.456 5.5 5.5 0 01-8.917 4.727l-.284.025a.75.75 0 01-.001-1.498z" clip-rule="evenodd" /></svg>';
        try {
          const response = await fetch(downloadUrl);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `${lastSuccessfulSearch.query.replace(/\s+/g, '_')}_by_${result.photographer.replace(/\s+/g, '_')}.${blob.type.split('/')[1]}`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
        } catch(err) {
            console.error("Download failed", err);
            alert("Le téléchargement a échoué. Veuillez réessayer.");
        } finally {
             e.currentTarget.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 1.5a.75.75 0 01.75.75V12h3.44l-4.19 4.19a.75.75 0 01-1.06 0L6.75 12h3.5V2.25A.75.75 0 0112 1.5zM3.75 16.5a.75.75 0 01.75.75v3c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75v-3a.75.75 0 011.5 0v3A2.25 2.25 0 0118.75 22.5H5.25A2.25 2.25 0 013 20.25v-3a.75.75 0 01.75-.75z"/></svg>';
        }
      });

      container.appendChild(media);
      container.appendChild(overlay);
      return container;
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) return;
        
        promptForm.querySelector('button').disabled = true;
        promptInput.disabled = true;
        addMessage('user', userPrompt);
        promptInput.value = '';

        const placeholder = document.createElement('div');
        placeholder.className = 'media-placeholder loading-shimmer';
        const placeholderMsg = addMessage('assistant', placeholder);
        
        const { query, type } = parsePrompt(userPrompt);

        if (!query) {
           placeholderMsg.remove();
           addMessage('assistant', "Je n'ai pas bien compris. Pouvez-vous reformuler votre demande ?");
           promptForm.querySelector('button').disabled = false;
           promptInput.disabled = false;
           return;
        }
        
        const result = await fetchFromPexels(query, type);
        placeholderMsg.remove();

        if (result) {
          const mediaElement = createMediaElement(result, type);
          addMessage('assistant', mediaElement);
        } else {
          addMessage('assistant', `Désolé, je n'ai rien trouvé pour "${query}". Essayez d'autres mots-clés.`);
        }
        
        promptForm.querySelector('button').disabled = false;
        promptInput.disabled = false;
        promptInput.focus();
    };

    promptForm.addEventListener('submit', handleFormSubmit);

    // Initial message
    addMessage('assistant', "Bonjour ! Je suis Apis. Décrivez-moi l'image ou la vidéo que vous souhaitez 'générer', et je m'en occupe.");
    
    // Background hex grid — NE PAS MODIFIER
    (function(){
      const c = document.getElementById('bg-canvas');
      const ctx = c.getContext('2d');
      function draw(){
        const dpr = window.devicePixelRatio || 1;
        const rect = c.getBoundingClientRect();
        c.width = rect.width * dpr; c.height = rect.height * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,rect.width,rect.height);
        const size = 24, hexW = 2 * size, hexH = Math.sqrt(3) * size, stepX = hexW * 3/4;
        ctx.strokeStyle = 'rgba(124,58,237,0.10)'; ctx.lineWidth = 1;
        for(let row=0; row*hexH < rect.height + hexH; row++){
          for(let col=0; col*stepX < rect.width + hexW; col++){
            const x = col * stepX, y = row * hexH + (col % 2 ? hexH/2 : 0);
            ctx.beginPath();
            for(let i=0;i<6;i++){
              const a = 2 * Math.PI / 6 * i, px = x + size * Math.cos(a), py = y + size * Math.sin(a);
              if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
            }
            ctx.closePath(); ctx.stroke();
          }
        }
      }
      window.addEventListener('resize', draw, {passive:true});
      draw();
    })();
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
