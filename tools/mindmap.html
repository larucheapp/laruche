<!DOCTYPE html>
<html lang="fr" data-app="laruche" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mind Map ‚Äî La Ruche</title>
  <meta name="description" content="Un outil de cr√©ation de cartes mentales (mind mapping) gratuit, infini et fonctionnant 100% en local dans votre navigateur.">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <style>
    :root{
      --color-bg:#FFFFFF;
      --color-bg-alt:#F7F8FA;
      --color-border:#E9EAF0;
      --color-text-primary:#141417;
      --color-text-secondary:#6B7280;
      --color-violet:#7C3AED;
      --color-violet-dark:#6D28D9;
      --radius-md:12px;
      --radius-lg:14px;
      --tool-max-w:480px; /* par d√©faut, peut √™tre chang√© via body[data-size] */
    }

    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{height:100%;background-color:var(--color-bg)}
    body{
      height:100vh; overflow:hidden; display:flex; flex-direction:column;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Inter",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--color-text-primary); line-height:1.5; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body[data-size="default"]{--tool-max-w:480px}
    body[data-size="wide"]{--tool-max-w:960px}
    body[data-size="xl"]{--tool-max-w:1200px}

    #bg-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:-1}

    .app-header{
      flex-shrink:0; background:var(--color-bg-alt); border-bottom:1px solid var(--color-border);
      padding:0 12px 0 24px; display:flex; align-items:center; justify-content:space-between; height:70px; gap:16px;
    }
    .app-header a{display:inline-flex; align-items:center; flex-shrink: 0;}
    .logo-img{height:70px; width:auto; vertical-align:middle}
    .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:nowrap; overflow-x: auto;}
    .sep{width:1px; height:24px; background:var(--color-border); margin:0 4px;}

    .main-content{
      flex-grow:1; display:flex; align-items:center; justify-content:center;
      padding:48px 24px; overflow-y:auto;
    }
    .tool-wrapper{display:flex; flex-direction:column; align-items:center; position:relative; width:100%; height:100%;}
    .tool-title{
      font-size:1.75rem; font-weight:600; padding:12px 28px;
      background:linear-gradient(45deg,var(--color-violet),var(--color-violet-dark));
      color:#fff; border-radius:var(--radius-md); margin-bottom:-20px; position:relative; z-index:5;
      box-shadow:0 4px 14px -4px rgba(124,58,237,.4);
    }
    .generator-card{
      background:var(--color-bg); border:1px solid var(--color-border); border-radius:var(--radius-lg);
      padding:16px; padding-top:40px; width:100%; max-width:var(--tool-max-w);
      box-shadow:0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      display:flex; flex-direction:column; gap:16px;
      flex-grow: 1; min-height: 0; /* Important for flex child */
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      font-weight:500; padding:8px 12px; border-radius:var(--radius-md); border:none; cursor:pointer;
      transition:background-color .2s, box-shadow .2s; font-size:14px; white-space:nowrap;
    }
    .btn svg { width: 16px; height: 16px; }
    .btn:focus-visible{outline:2px solid transparent; outline-offset:2px; box-shadow:0 0 0 3px rgba(124,58,237,.4)}
    .btn-primary{background:var(--color-violet); color:#fff}
    .btn-primary:hover:not(:disabled){background:var(--color-violet-dark)}
    .btn-secondary{ background-color: var(--color-bg); border: 1px solid var(--color-border); color: var(--color-text-primary); }
    .btn-secondary:hover:not(:disabled){border-color:var(--color-violet); color:var(--color-violet)}
    .btn:disabled{background:#A78BFA; cursor:not-allowed}
    .hidden{display:none!important}
    
    /* Mind Map Specific Styles */
    .workspace {
      position: relative;
      border-radius: var(--radius-md);
      overflow: hidden;
      background-color: var(--color-bg-alt);
      border: 1px solid var(--color-border);
      flex-grow: 1; /* Take all available space in the card */
    }
    .view { position:absolute; inset:0; cursor:grab; }
    .view.panning { cursor:grabbing; }
    .world { position:absolute; left:0; top:0; transform-origin:0 0; }
    .grid {
      position:absolute; inset:0; pointer-events:none;
      background-image:
        linear-gradient(var(--color-border) 1px, transparent 1px),
        linear-gradient(90deg, var(--color-border) 1px, transparent 1px);
      background-size:64px 64px, 64px 64px;
    }
    svg#edges { position:absolute; inset:0; overflow:visible; pointer-events:none; }

    .node {
      position:absolute; min-width:160px; max-width:320px;
      user-select:none; transform:translate(-50%,-50%);
    }
    .bubble {
      background: var(--color-bg);
      border:1px solid var(--color-border);
      border-radius: var(--radius-md); padding:10px 14px;
      box-shadow:0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
    }
    .node.selected .bubble {
      border-color: var(--color-violet);
      box-shadow:0 0 0 3px rgba(124,58,237,.2), 0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
    }
    .title[contenteditable] { outline:none; font-weight:600; font-size:15px; }
    .thumb { margin-top:8px; border-radius:8px; max-height:180px; max-width:100%; display:block; border:1px solid var(--color-border); }
    .pdf-pill {
      margin-top:8px; display:inline-flex; gap:6px; align-items:center;
      padding:4px 10px; border-radius:999px; background:var(--color-bg-alt);
      border:1px solid var(--color-border); font-size:12px; color:var(--color-text-secondary);
      text-decoration: none;
    }
    .pdf-pill:hover { color: var(--color-violet); }
    
    .info-footer {
        flex-shrink: 0;
        font-size: 12px;
        color: var(--color-text-secondary);
        text-align: center;
        padding: 8px;
        background: var(--color-bg-alt);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
    }
    #status {
      position: fixed;
      bottom: 16px;
      right: 24px;
      font-size: 13px;
      padding: 6px 12px;
      background: var(--color-bg-alt);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow:0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      z-index: 50;
    }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body data-size="xl">
  <canvas id="bg-canvas"></canvas>

  <header class="app-header">
    <a href="/" aria-label="Accueil">
      <img src="logo-2.png" alt="Logo La Ruche" class="logo-img">
    </a>
    <div class="toolbar">
        <button class="btn btn-secondary" id="addChild"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m-7-7h14"/></svg>Enfant</button>
        <button class="btn btn-secondary" id="addSibling"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m-7-7h14"/></svg>Fr√®re</button>
        <div class="sep"></div>
        <button class="btn btn-secondary" id="attachImg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M20.4 14.5L16 10 4 20"/></svg>Image</button>
        <button class="btn btn-secondary" id="attachPDF"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>PDF</button>
        <input type="file" id="imgInput" accept="image/*" class="hidden"/>
        <input type="file" id="pdfInput" accept="application/pdf" class="hidden"/>
        <div class="sep"></div>
        <button class="btn btn-secondary" id="zoomOut"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M8 11h6"/></svg></button>
        <button class="btn btn-secondary" id="zoomIn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M11 8v6M8 11h6"/></svg></button>
        <button class="btn btn-secondary" id="center"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18M12 3v18"/></svg></button>
        <div class="sep"></div>
        <button class="btn btn-primary" id="exportPNG">Exporter PNG</button>
        <button class="btn btn-primary" id="exportPDF">Exporter PDF</button>
    </div>
  </header>

  <main class="main-content">
    <div class="tool-wrapper">
      <h1 class="tool-title">Carte Mentale</h1>
      <div class="generator-card" role="region" aria-label="√âditeur de carte mentale">
        <section class="workspace" id="workspace">
            <div class="view" id="view">
                <div class="world" id="world">
                    <div class="grid"></div>
                    <svg id="edges"></svg>
                </div>
            </div>
        </section>
        <div class="info-footer">
            <b>Astuce :</b> D√©posez une image/PDF pour cr√©er un n≈ìud. <b>Raccourcis :</b> Entr√©e/Tab = enfant, Suppr = supprimer, Espace+glisser = d√©placer, Ctrl/‚åò+molette = zoom.
        </div>
      </div>
    </div>
  </main>
  
  <div id="status">Pr√™t</div>

  <script>
    // Background hex grid
    (function(){
      const c = document.getElementById('bg-canvas'); if(!c) return; const ctx = c.getContext('2d');
      function draw(){
        const dpr = window.devicePixelRatio || 1; const rect = c.getBoundingClientRect(); c.width = rect.width * dpr; c.height = rect.height * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,rect.width,rect.height);
        const size = 24, hexW = 2*size, hexH = Math.sqrt(3)*size, stepX = hexW*3/4;
        ctx.strokeStyle = 'rgba(124,58,237,0.10)'; ctx.lineWidth = 1;
        for(let row=0; row*hexH < rect.height+hexH; row++){
          for(let col=0; col*stepX < rect.width+hexW; col++){
            const x = col*stepX, y = row*hexH + (col % 2 ? hexH/2 : 0);
            ctx.beginPath();
            for(let i=0;i<6;i++){ const a = 2*Math.PI/6*i, px = x+size*Math.cos(a), py = y+size*Math.sin(a); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); }
            ctx.closePath(); ctx.stroke();
          }
        }
      }
      window.addEventListener('resize', draw, {passive:true}); draw();
    })();
  </script>
  <script>
window.addEventListener('DOMContentLoaded', () => {
/* ================== State ================== */
const WORLD_SIZE=12000, HALF=WORLD_SIZE/2, SCALE_MIN=0.2, SCALE_MAX=2.5;
const state = {
  nodes:new Map(), sizes:new Map(),
  rootId:null, selectedId:null,
  scale:1, origin:{x:HALF, y:HALF}
};
const ws = document.getElementById('workspace');
const view = document.getElementById('view');
const world = document.getElementById('world');
const edgesSvg = document.getElementById('edges');
const statusEl = document.getElementById('status');

/* ================== Utils ================== */
const uid = ()=> Math.random().toString(36).slice(2,9);
const setStatus = t => { statusEl.textContent=t; statusEl.style.opacity = '1'; setTimeout(() => statusEl.style.opacity = '0', 2500); };
const ensureSel = ()=> { if(!state.selectedId && state.rootId) selectNode(state.rootId); return !!state.selectedId; };
const applyTransform = ()=> world.style.transform = `translate(${-state.origin.x}px, ${-state.origin.y}px) scale(${state.scale})`;

function screenToWorld(px, py){
  const r = ws.getBoundingClientRect();
  const vx = px - r.left, vy = py - r.top;
  return { x: state.origin.x + vx/state.scale, y: state.origin.y + vy/state.scale };
}
function clampOrigin(){
  const maxX = Math.max(0, WORLD_SIZE - ws.clientWidth/state.scale);
  const maxY = Math.max(0, WORLD_SIZE - ws.clientHeight/state.scale);
  state.origin.x = Math.max(0, Math.min(maxX, state.origin.x));
  state.origin.y = Math.max(0, Math.min(maxY, state.origin.y));
}

let zoomAnim=null;
function smoothZoom(screenX, screenY, targetScale, ms=160){
  if(zoomAnim) cancelAnimationFrame(zoomAnim);
  const startScale = state.scale;
  targetScale = Math.max(SCALE_MIN, Math.min(SCALE_MAX, targetScale));
  if (startScale === targetScale) return;
  const start = performance.now();
  const before = screenToWorld(screenX, screenY);

  const step = (now)=>{
    const t = Math.min(1, (now-start)/ms);
    const ease = 1 - Math.pow(1-t, 3); // easeOutCubic
    state.scale = startScale + (targetScale - startScale) * ease;
    const after = screenToWorld(screenX, screenY);
    state.origin.x += (after.x - before.x);
    state.origin.y += (after.y - before.y);
    clampOrigin(); applyTransform();
    if(t<1) zoomAnim = requestAnimationFrame(step);
  };
  zoomAnim = requestAnimationFrame(step);
}

function fileToURL(f){
  return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
}

/* ================== Nodes ================== */
function createNode({x,y,text='Nouvelle id√©e',parentId=null,imgSrc=null,pdfUrl=null,pdfName=null}){
  const id=uid();
  state.nodes.set(id,{id,x,y,text,parentId,imgSrc,pdfUrl,pdfName});
  if(!state.rootId) state.rootId=id;
  renderNode(id); selectNode(id); scheduleEdges();
  return id;
}
function measureNode(id){
  const el = world.querySelector(`.node[data-id="${id}"]`); if(!el) return;
  const bubble = el.querySelector('.bubble') || el;
  state.sizes.set(id,{w: bubble.offsetWidth, h: bubble.offsetHeight});
}
function renderNode(id){
  const n = state.nodes.get(id); if(!n) return;
  let el = world.querySelector(`.node[data-id="${id}"]`);
  if(!el){
    el = document.createElement('div'); el.className='node'; el.dataset.id=id;
    el.innerHTML = `
      <div class="bubble">
        <div class="title" contenteditable="true"></div>
        <img class="thumb hidden" alt="Aper√ßu image">
        <a class="pdf-pill hidden" target="_blank" rel="noopener noreferrer">üìÑ <span class="name"></span></a>
      </div>`;
    world.appendChild(el);

    el.addEventListener('mousedown', e=>{ if(e.button!==0 || e.target.closest('.title')) return; startDragNode(e, id); });
    el.addEventListener('click', e=>{ selectNode(id); e.stopPropagation(); });

    const title = el.querySelector('.title');
    title.addEventListener('input', ()=>{ state.nodes.get(id).text = title.textContent.trim()||'Nouvelle id√©e'; measureNode(id); scheduleEdges(); });
    title.addEventListener('mousedown', e=> e.stopPropagation());
  }
  el.style.left = n.x+'px'; el.style.top = n.y+'px';
  el.querySelector('.title').textContent = n.text || 'Nouvelle id√©e';

  const imgEl = el.querySelector('.thumb');
  if(n.imgSrc){ imgEl.src=n.imgSrc; imgEl.classList.remove('hidden'); imgEl.onload = ()=>{ measureNode(id); scheduleEdges(); }; }
  else { imgEl.removeAttribute('src'); imgEl.classList.add('hidden'); }

  const pdfEl = el.querySelector('.pdf-pill');
  if(n.pdfUrl){ pdfEl.href=n.pdfUrl; pdfEl.querySelector('.name').textContent=n.pdfName||'document.pdf'; pdfEl.classList.remove('hidden'); }
  else{ pdfEl.classList.add('hidden'); pdfEl.removeAttribute('href'); }

  measureNode(id);
}
function selectNode(id){
  state.selectedId=id;
  world.querySelectorAll('.node').forEach(n=> n.classList.toggle('selected', n.dataset.id===id));
}
function removeNode(id){
  if(id===state.rootId) return;
  for(const n of Array.from(state.nodes.values())) if(n.parentId===id) removeNode(n.id);
  state.nodes.delete(id); state.sizes.delete(id);
  world.querySelector(`.node[data-id="${id}"]`)?.remove();
  if(state.selectedId===id) state.selectedId=state.rootId;
  drawEdges();
}

/* ================== Edges ================== */
function cubicPath(a,b){ const dx=(b.x-a.x)*0.5; return `M ${a.x} ${a.y} C ${a.x+dx} ${a.y}, ${b.x-dx} ${b.y}, ${b.x} ${b.y}`; }
let raf=null; const scheduleEdges=()=>{ if(raf) cancelAnimationFrame(raf); raf=requestAnimationFrame(drawEdges); };
function drawEdges(){
  raf = null;
  const frag = document.createDocumentFragment();
  for(const n of state.nodes.values()){
    if(!n.parentId || !state.nodes.has(n.parentId)) continue;
    const p = state.nodes.get(n.parentId), c = n;
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', cubicPath(p,c));
    path.setAttribute('fill','none'); path.setAttribute('stroke', 'var(--color-violet)'); path.setAttribute('stroke-width','1.5');
    frag.appendChild(path);
  }
  edgesSvg.innerHTML = '';
  edgesSvg.appendChild(frag);
}

/* ================== Pan / Zoom ================== */
let pan=false, panStart={x:0,y:0}, originStart={x:0,y:0};
view.addEventListener('mousedown', e=>{
  if(e.button!==0 && e.button!==1 || !(e.target===view || e.target===world || e.target.classList.contains('grid'))) return;
  if(!e.ctrlKey){ pan=true; panStart={x:e.clientX,y:e.clientY}; originStart={...state.origin}; view.classList.add('panning'); }
});
window.addEventListener('mousemove', e=>{ if(!pan) return; state.origin={x:originStart.x-(e.clientX-panStart.x)/state.scale, y:originStart.y-(e.clientY-panStart.y)/state.scale}; clampOrigin(); applyTransform(); });
window.addEventListener('mouseup', ()=>{ pan=false; view.classList.remove('panning'); });

view.addEventListener('wheel', e=>{
  if(!e.ctrlKey && !e.metaKey) return;
  e.preventDefault();
  smoothZoom(e.clientX, e.clientY, state.scale * Math.exp(-e.deltaY*0.0015));
}, {passive:false});

let gestureStartScale=1;
view.addEventListener('gesturestart', e=>{ e.preventDefault(); gestureStartScale=state.scale; }, {passive:false});
view.addEventListener('gesturechange', e=>{ e.preventDefault(); setScaleAround(e.clientX,e.clientY, gestureStartScale*e.scale); }, {passive:false});

document.getElementById('zoomIn').onclick = ()=> { const r = ws.getBoundingClientRect(); smoothZoom(r.left+r.width/2, r.top+r.height/2, state.scale*1.2); };
document.getElementById('zoomOut').onclick = ()=> { const r = ws.getBoundingClientRect(); smoothZoom(r.left+r.width/2, r.top+r.height/2, state.scale/1.2); };
document.getElementById('center').onclick = ()=>{ state.scale=1; centerOn(state.rootId); };
function centerOn(id){
  const n = state.nodes.get(id); if(!n) return;
  state.origin.x = n.x - (ws.clientWidth/2)/state.scale;
  state.origin.y = n.y - (ws.clientHeight/2)/state.scale;
  clampOrigin(); applyTransform();
}
window.addEventListener('resize', ()=>{ clampOrigin(); applyTransform(); });

/* ================== Drag nodes ================== */
let dragId=null, dragStart=null, nodeStart=null;
function startDragNode(e,id){
  dragId=id; dragStart={x:e.clientX,y:e.clientY}; nodeStart={...state.nodes.get(id)}; selectNode(id);
  window.addEventListener('mousemove', dragMove); window.addEventListener('mouseup', dragEnd, {once:true});
}
function dragMove(e){
  if(!dragId) return;
  const n=state.nodes.get(dragId);
  n.x=nodeStart.x+(e.clientX-dragStart.x)/state.scale; n.y=nodeStart.y+(e.clientY-dragStart.y)/state.scale;
  renderNode(dragId); scheduleEdges();
}
function dragEnd(){ dragId=null; window.removeEventListener('mousemove', dragMove); }

/* ================== Actions ================== */
function addChildTo(id){
  const p = state.nodes.get(id);
  createNode({x:p.x+240, y:p.y+(Math.random()*120-60), text:'Id√©e enfant', parentId:id});
}
document.getElementById('addChild').onclick = ()=> { if(ensureSel()) addChildTo(state.selectedId); };
document.getElementById('addSibling').onclick = ()=>{
  if(!ensureSel()) return;
  const s=state.nodes.get(state.selectedId); if(!s?.parentId) return;
  const p=state.nodes.get(s.parentId);
  createNode({x:p.x+240, y:p.y+(Math.random()*120-60), text:'Id√©e fr√®re', parentId:p.id});
};
window.addEventListener('keydown', e=>{
  const activeEl = document.activeElement;
  if (e.code==='Space' && activeEl.tagName !== 'INPUT' && activeEl.contentEditable !== 'true') view.classList.add('panning');
  if((e.key==='Enter'||e.key==='Tab') && activeEl.contentEditable!=='true'){ e.preventDefault(); if(ensureSel()) addChildTo(state.selectedId); }
  if((e.key==='Delete'||e.key==='Backspace') && activeEl.contentEditable!=='true'){ if(ensureSel()) removeNode(state.selectedId); }
});
window.addEventListener('keyup', e=>{ if(e.code==='Space') view.classList.remove('panning'); });

/* ================== Attachments ================== */
const imgInput=document.getElementById('imgInput'), pdfInput=document.getElementById('pdfInput');
document.getElementById('attachImg').onclick = ()=> imgInput.click();
document.getElementById('attachPDF').onclick = ()=> pdfInput.click();

async function attachFileToNode(file, isImage) {
    if(!ensureSel()) return;
    const url = await fileToURL(file);
    const n = state.nodes.get(state.selectedId);
    if(isImage) { n.imgSrc = url; setStatus('Image ajout√©e'); }
    else { n.pdfUrl = url; n.pdfName = file.name; setStatus('PDF li√©'); }
    renderNode(n.id);
}
imgInput.addEventListener('change', e => e.target.files?.[0] && attachFileToNode(e.target.files[0], true));
pdfInput.addEventListener('change', e => e.target.files?.[0] && attachFileToNode(e.target.files[0], false));

view.addEventListener('dragover', e=> e.preventDefault());
view.addEventListener('drop', async e=>{
  e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(!f) return;
  const pt=screenToWorld(e.clientX,e.clientY); const url=await fileToURL(f);
  const parentId = state.selectedId || state.rootId;
  if(f.type.startsWith('image/')){
    const id=createNode({x:pt.x,y:pt.y,text:'Image',parentId});
    state.nodes.get(id).imgSrc=url; renderNode(id);
  } else if(f.type==='application/pdf'){
    const id=createNode({x:pt.x,y:pt.y,text:'PDF',parentId});
    const n=state.nodes.get(id); n.pdfUrl=url; n.pdfName=f.name; renderNode(id);
  }
  scheduleEdges();
});

/* ================== Export ================== */
function computeBounds(){
  if(state.nodes.size===0) return {x:0,y:0,w:1000,h:600};
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  for(const n of state.nodes.values()){
    const sz = state.sizes.get(n.id) || {w:220,h:70};
    minX=Math.min(minX, n.x - sz.w/2); minY=Math.min(minY, n.y - sz.h/2);
    maxX=Math.max(maxX, n.x + sz.w/2); maxY=Math.max(maxY, n.y + sz.h/2);
  }
  const M=80; // marge
  return {x:minX-M,y:minY-M,w:(maxX-minX)+2*M,h:(maxY-minY)+2*M};
}

async function waitImagesLoaded(scope){
  const imgs = Array.from(scope.querySelectorAll('img')).filter(i=>!i.complete);
  if(imgs.length === 0) return;
  await Promise.race([
    Promise.all(imgs.map(i=> new Promise(res=>{ i.onload=i.onerror=res; }))),
    new Promise(res=> setTimeout(res, 1000))
  ]);
}
const escapeHtml = s => (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

function buildExportFrame(){
  const box=computeBounds();
  const frame=document.createElement('div');
  frame.style.cssText = `position:fixed; left:-99999px; top:-99999px; width:${box.w}px; height:${box.h}px;`;
  document.body.appendChild(frame);
  
  const styles = `
    :root{ --color-bg:#FFFFFF; --color-bg-alt:#F7F8FA; --color-border:#E9EAF0; --color-text-primary:#141417; --color-text-secondary:#6B7280; --color-violet:#7C3AED; --radius-md:12px; }
    body { background-color: var(--color-bg-alt); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,sans-serif; }
    .node { position:absolute; transform:translate(-50%,-50%); }
    .bubble { background:var(--color-bg); border:1px solid var(--color-border); border-radius:var(--radius-md); padding:10px 14px; box-shadow:0 4px 6px -1px rgb(0 0 0 / 5%); }
    .title { font-weight:600; font-size:15px; color: var(--color-text-primary); }
    .thumb { margin-top:8px; border-radius:8px; max-height:180px; max-width:100%; display:block; border:1px solid var(--color-border); }
    .pdf-pill { margin-top:8px; display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border-radius:999px; background:var(--color-bg-alt); border:1px solid var(--color-border); font-size:12px; color:var(--color-text-secondary); }
  `;
  const styleEl = document.createElement('style');
  styleEl.textContent = styles;
  frame.appendChild(styleEl);
  
  const wrap=document.createElement('div');
  wrap.style.cssText = `position:relative; width:100%; height:100%; background-color: var(--color-bg-alt);`;
  frame.appendChild(wrap);

  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('width',box.w); svg.setAttribute('height',box.h);
  svg.style.cssText = 'position:absolute; left:0; top:0;'; wrap.appendChild(svg);

  for(const n of state.nodes.values()){
    if(!n.parentId || !state.nodes.has(n.parentId)) continue;
    const p=state.nodes.get(n.parentId);
    const A={x:p.x-box.x,y:p.y-box.y}, B={x:n.x-box.x,y:n.y-box.y};
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', cubicPath(A,B));
    path.setAttribute('fill','none'); path.setAttribute('stroke', '#7C3AED'); path.setAttribute('stroke-width','1.5');
    svg.appendChild(path);
  }

  for(const n of state.nodes.values()){
    const el=document.createElement('div');
    el.className='node'; el.style.left=(n.x-box.x)+'px'; el.style.top=(n.y-box.y)+'px';
    el.innerHTML = `
      <div class="bubble">
        <div class="title">${escapeHtml(n.text||'Nouvelle id√©e')}</div>
        ${n.imgSrc?`<img class="thumb" src="${n.imgSrc}"/>`:''}
        ${n.pdfUrl?`<div class="pdf-pill">üìÑ ${escapeHtml(n.pdfName||'document.pdf')}</div>`:''}
      </div>`;
    wrap.appendChild(el);
  }
  return {frame};
}

async function exportPNG(){
  setStatus('Pr√©paration de l\'export PNG...');
  const {frame} = buildExportFrame();
  await waitImagesLoaded(frame);
  const canvas = await html2canvas(frame,{backgroundColor:null,scale:2});
  frame.remove();
  const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='mindmap.png'; a.click();
  setStatus('PNG t√©l√©charg√© !');
}
async function exportPDF(){
  setStatus('Pr√©paration de l\'export PDF...');
  const { jsPDF } = window.jspdf;
  const {frame} = buildExportFrame();
  await waitImagesLoaded(frame);
  const canvas = await html2canvas(frame,{backgroundColor:getComputedStyle(document.body).getPropertyValue('--color-bg-alt'), scale:2});
  frame.remove();
  const img = canvas.toDataURL('image/png');
  const landscape = canvas.width>=canvas.height;
  const pdf = new jsPDF({orientation:landscape?'l':'p',unit:'pt',format:'a4'});
  const W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();
  const r=Math.min(W/canvas.width,H/canvas.height), w=canvas.width*r, h=canvas.height*r, x=(W-w)/2, y=(H-h)/2;
  pdf.addImage(img,'PNG',x,y,w,h); pdf.save('mindmap.pdf');
  setStatus('PDF t√©l√©charg√© !');
}
document.getElementById('exportPNG').onclick = exportPNG;
document.getElementById('exportPDF').onclick = exportPDF;

/* ================== Init ================== */
function init(){
  applyTransform();
  const root = createNode({x:HALF, y:HALF, text:'Ma nouvelle carte mentale'});
  selectNode(root); centerOn(root);
  setStatus('Bienvenue ! Double-cliquez pour √©diter.');
}
init();
});
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
