<!DOCTYPE html>
<html lang="fr" data-app="laruche">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Convertisseur - La Ruche</title>
  <meta name="description" content="Convertissez des cryptomonnaies en Euros ou Dollars avec les taux en temps réel.">
  <style>
    :root{
      --color-bg:#FFFFFF;
      --color-bg-alt:#F7F8FA;
      --color-border:#E9EAF0;
      --color-text-primary:#141417;
      --color-text-secondary:#6B7280;
      --color-violet:#7C3AED;
      --color-violet-dark:#6D28D9;
      --radius-md:12px;
      --radius-lg:14px;
      --tool-max-w:480px; /* par défaut, peut être changé via body[data-size] */
    }

    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{height:100%;background-color:var(--color-bg)}
    body{
      height:100vh; overflow:hidden; display:flex; flex-direction:column;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Inter",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--color-text-primary); line-height:1.5; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body[data-size="default"]{--tool-max-w:480px}
    body[data-size="wide"]{--tool-max-w:960px}
    body[data-size="xl"]{--tool-max-w:1200px}

    #bg-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:-1}

    .app-header{
      flex-shrink:0; background:var(--color-bg-alt); border-bottom:1px solid var(--color-border);
      padding:0 24px; display:flex; align-items:center; height:70px;
    }
    .app-header a{display:inline-flex; align-items:center}
    .logo-img{height:70px; width:auto; vertical-align:middle}

    .main-content{
      flex-grow:1; display:flex; align-items:center; justify-content:center;
      padding:48px 24px; overflow-y:auto;
    }
    .tool-wrapper{display:flex; flex-direction:column; align-items:center; position:relative}
    .tool-title{
      font-size:1.75rem; font-weight:600; padding:12px 28px;
      background:linear-gradient(45deg,var(--color-violet),var(--color-violet-dark));
      color:#fff; border-radius:var(--radius-md); margin-bottom:-20px; position:relative; z-index:5;
      box-shadow:0 4px 14px -4px rgba(124,58,237,.4);
    }
    .generator-card{
      background:var(--color-bg); border:1px solid var(--color-border); border-radius:var(--radius-lg);
      padding:28px; padding-top:40px; width:100%; max-width:var(--tool-max-w);
      box-shadow:0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      display:flex; flex-direction:column; gap:24px;
    }
    
    .status-text{font-size:14px; color:var(--color-text-secondary); text-align:center; min-height:21px}

    /* ===== STYLES CONVERTISSEUR ===== */
    .converter-wrapper {
      background-color: var(--color-bg-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 8px;
    }

    .currency-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
    }
    .currency-info { min-width: 140px; }
    .currency-row .form-label {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: 4px;
    }
    .amount-input {
      border: none;
      background: none;
      font-size: 2rem;
      font-weight: 600;
      color: var(--color-text-primary);
      text-align: right;
      width: 100%;
      padding: 4px;
      border-radius: var(--radius-md);
    }
    .amount-input:focus {
      outline: none;
      box-shadow: inset 0 0 0 2px var(--color-border);
    }

    .swap-divider {
      position: relative;
      height: 1px;
      background-color: var(--color-border);
      margin: 0 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #swap-btn {
      position: absolute;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 4px solid var(--color-bg-alt);
      background-color: var(--color-violet);
      color: #fff;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s;
    }
    
    #swap-btn:hover {
      background-color: var(--color-violet-dark);
      transform: rotate(180deg) scale(1.1);
    }
    
    #swap-btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px var(--color-bg), 0 0 0 5px var(--color-violet);
    }

    /* == Custom Select Dropdown == */
    .custom-select-wrapper { position: relative; }
    .custom-select-trigger {
      display: flex;
      align-items: center;
      gap: 12px;
      border: none;
      background: none;
      cursor: pointer;
      padding: 4px 8px;
      margin-left: -8px;
      border-radius: var(--radius-md);
      transition: background-color 0.2s;
      width: 100%;
      text-align: left;
    }
    .custom-select-trigger:hover {
      background-color: rgba(0,0,0,0.05);
    }
    .custom-select-trigger:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }
    .custom-select-trigger .logo-icon {
      width: 32px;
      height: 32px;
      object-fit: contain;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .custom-select-trigger .currency-code {
      font-weight: 600;
      font-size: 1.5rem;
      color: var(--color-text-primary);
    }
    .custom-select-options {
      position: absolute;
      top: 110%;
      left: 0;
      width: 280px;
      max-height: 300px;
      overflow-y: auto;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 10%), 0 4px 6px -4px rgb(0 0 0 / 10%);
      z-index: 100;
      padding: 8px;
    }
    .custom-select-options.hidden {
      display: none;
    }
    .option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      cursor: pointer;
      border-radius: 8px;
    }
    .option:hover, .option.focused {
      background-color: var(--color-bg-alt);
    }
    .option .logo-icon {
      width: 24px;
      height: 24px;
      object-fit: contain;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option .option-info {
        display: flex;
        align-items: baseline;
        gap: 8px;
        flex-grow: 1;
        flex-wrap: wrap;
    }
    .option .option-name {
        color: var(--color-text-primary);
        font-weight: 500;
    }
    .option .option-symbol {
        color: var(--color-text-secondary);
        font-size: 0.875rem;
    }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body data-size="default">
  <canvas id="bg-canvas"></canvas>

  <header class="app-header">
    <a href="/" aria-label="Accueil">
      <img src="logo-2.png" alt="Logo La Ruche" class="logo-img">
    </a>
  </header>

  <main class="main-content">
    <div class="tool-wrapper">
      <h1 class="tool-title">Crypto Convertisseur</h1>
      
      <div class="generator-card" role="region" aria-label="Convertisseur de Cryptomonnaies">
        
        <div class="converter-wrapper">
          <!-- Panneau du haut -->
          <div id="top-row" class="currency-row">
             <!-- Contenu généré par JS -->
          </div>

          <!-- Séparateur avec bouton Swap -->
          <div class="swap-divider">
            <button id="swap-btn" aria-label="Inverser les devises">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
            </button>
          </div>

          <!-- Panneau du bas -->
          <div id="bottom-row" class="currency-row">
             <!-- Contenu généré par JS -->
          </div>
        </div>
        
        <div id="rate-info" class="status-text">
          Chargement des taux...
        </div>
      </div>
      
    </div>
  </main>

  <script>
    // Background hex grid — NE PAS MODIFIER
    (function(){
      const c = document.getElementById('bg-canvas');
      const ctx = c.getContext('2d');
      function draw(){
        const dpr = window.devicePixelRatio || 1;
        const rect = c.getBoundingClientRect();
        c.width = rect.width * dpr; c.height = rect.height * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,rect.width,rect.height);
        const size=24,hexW=2*size,hexH=Math.sqrt(3)*size,stepX=hexW*3/4;
        ctx.strokeStyle='rgba(124,58,237,0.10)'; ctx.lineWidth=1;
        for(let r=0;r*hexH<rect.height+hexH;r++) for(let col=0;col*stepX<rect.width+hexW;col++){
          const x=col*stepX, y=r*hexH+(col%2?hexH/2:0);
          ctx.beginPath();
          for(let i=0;i<6;i++){ const a=2*Math.PI/6*i,px=x+size*Math.cos(a),py=y+size*Math.sin(a); if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py); }
          ctx.closePath(); ctx.stroke();
        }
      }
      window.addEventListener('resize', draw, {passive:true}); draw();
    })();
  </script>
  
  <script>
    const topRow = document.getElementById('top-row');
    const bottomRow = document.getElementById('bottom-row');
    const swapBtn = document.getElementById('swap-btn');
    const rateInfo = document.getElementById('rate-info');
    
    let rates = {};
    let isUpdating = false;

    // Liste de cryptos étendue
    const CRYPTOS = {
      bitcoin: { symbol: 'BTC', name: 'Bitcoin' },
      ethereum: { symbol: 'ETH', name: 'Ethereum' },
      tether: { symbol: 'USDT', name: 'Tether' },
      binancecoin: { symbol: 'BNB', name: 'BNB' },
      solana: { symbol: 'SOL', name: 'Solana' },
      ripple: { symbol: 'XRP', name: 'XRP' },
      'usd-coin': { symbol: 'USDC', name: 'USD Coin' },
      cardano: { symbol: 'ADA', name: 'Cardano' },
      dogecoin: { symbol: 'DOGE', name: 'Dogecoin' },
      avalanche: { symbol: 'AVAX', name: 'Avalanche' },
      chainlink: { symbol: 'LINK', name: 'Chainlink' },
      polkadot: { symbol: 'DOT', name: 'Polkadot' },
      tron: { symbol: 'TRX', name: 'TRON' },
      polygon: { symbol: 'MATIC', name: 'Polygon' },
      litecoin: { symbol: 'LTC', name: 'Litecoin' },
      'internet-computer': { symbol: 'ICP', name: 'Internet Computer' },
      'bitcoin-cash': { symbol: 'BCH', name: 'Bitcoin Cash' },
      'shiba-inu': { symbol: 'SHIB', name: 'Shiba Inu' },
      uniswap: { symbol: 'UNI', name: 'Uniswap' },
      stellar: { symbol: 'XLM', name: 'Stellar' },
      'the-open-network': { symbol: 'TON', name: 'Toncoin' },
      near: { symbol: 'NEAR', name: 'NEAR Protocol' },
      pepe: { symbol: 'PEPE', name: 'Pepe' },
      'ethereum-classic': { symbol: 'ETC', name: 'Ethereum Classic' },
      monero: { symbol: 'XMR', name: 'Monero' },
      cosmos: { symbol: 'ATOM', name: 'Cosmos Hub' },
      filecoin: { symbol: 'FIL', name: 'Filecoin' },
      dai: { symbol: 'DAI', name: 'Dai' },
      render: { symbol: 'RNDR', name: 'Render' },
      'the-graph': { symbol: 'GRT', name: 'The Graph' },
      'hedera-hashgraph': { symbol: 'HBAR', name: 'Hedera' },
      arbitrum: { symbol: 'ARB', name: 'Arbitrum' },
      'immutable-x': { symbol: 'IMX', name: 'Immutable' },
      blockstack: { symbol: 'STX', name: 'Stacks' },
      aptos: { symbol: 'APT', name: 'Aptos' },
      optimism: { symbol: 'OP', name: 'Optimism' },
      vechain: { symbol: 'VET', name: 'VeChain' },
      celestia: { symbol: 'TIA', name: 'Celestia' },
      algorand: { symbol: 'ALGO', name: 'Algorand' },
      fantom: { symbol: 'FTM', name: 'Fantom' },
      'theta-token': { symbol: 'THETA', name: 'Theta Network' },
      jasmycoin: { symbol: 'JASMY', name: 'JasmyCoin' },
      bonk: { symbol: 'BONK', name: 'Bonk' },
      'lido-dao': { symbol: 'LDO', name: 'Lido DAO' },
      'fetch-ai': { symbol: 'FET', name: 'Fetch.ai' }
    };

    const FIAT_CURRENCIES = {
        EUR: { name: 'Euro', country: 'eu' },
        USD: { name: 'US Dollar', country: 'us' }
    };
    
    let appState = {
        top: { type: 'fiat', id: 'EUR', amount: 1000 },
        bottom: { type: 'crypto', id: 'bitcoin', amount: 0 }
    };

    async function fetchRates() {
      const cryptoIds = Object.keys(CRYPTOS).join(',');
      const fiatIds = Object.keys(FIAT_CURRENCIES).map(c => c.toLowerCase()).join(',');
      const API_URL = `https://api.coingecko.com/api/v3/simple/price?ids=${cryptoIds}&vs_currencies=${fiatIds}`;
      
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('Erreur réseau');
        rates = await response.json();
        render();
        convert();
      } catch (error) {
        rateInfo.textContent = 'Impossible de charger les taux.';
        console.error("Erreur de fetch:", error);
      }
    }

    function render() {
        topRow.innerHTML = buildRow(appState.top, 'top');
        bottomRow.innerHTML = buildRow(appState.bottom, 'bottom');
        attachEventListeners();
        updateRateInfo();
    }

    function buildRow(state, position) {
        const amountId = `${position}-amount`;
        const currencyId = `${position}-currency`;
        const selectData = state.type === 'fiat' 
            ? { list: FIAT_CURRENCIES, currentId: state.id, label: 'Monnaie' }
            : { list: CRYPTOS, currentId: state.id, label: 'Crypto' };

        const currentInfo = selectData.list[state.id];
        
        const triggerImageHtml = state.type === 'fiat'
            ? `<img src="https://flagcdn.com/w40/${currentInfo.country}.png" alt="" class="logo-icon" referrerpolicy="no-referrer">`
            : '';

        const optionsHtml = Object.entries(selectData.list).map(([id, info]) => {
            const optionImageHtml = state.type === 'fiat'
                ? `<img src="https://flagcdn.com/w40/${info.country}.png" alt="" class="logo-icon" referrerpolicy="no-referrer">`
                : '';
            return `
                <div class="option" data-id="${id}" role="option" tabindex="-1">
                    ${optionImageHtml}
                    <div class="option-info">
                       <span class="option-name">${info.name}</span>
                       <span class="option-symbol">${state.type === 'fiat' ? id : info.symbol}</span>
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="currency-info">
              <label class="form-label">${selectData.label}</label>
              <div id="${currencyId}" class="custom-select-wrapper">
                <button class="custom-select-trigger" aria-haspopup="listbox" aria-expanded="false">
                   ${triggerImageHtml}
                   <span class="currency-code">${state.type === 'fiat' ? state.id : currentInfo.symbol}</span>
                </button>
                <div class="custom-select-options hidden" role="listbox">
                    ${optionsHtml}
                </div>
              </div>
            </div>
            <input type="number" id="${amountId}" class="amount-input" value="${state.amount}" step="any" min="0">
        `;
    }

    function attachEventListeners() {
        ['top', 'bottom'].forEach(position => {
            const rowEl = position === 'top' ? topRow : bottomRow;
            const state = position === 'top' ? appState.top : appState.bottom;
            
            rowEl.querySelector('.amount-input').addEventListener('input', (e) => {
                state.amount = parseFloat(e.target.value) || 0;
                convert(position);
            });
            
            const trigger = rowEl.querySelector('.custom-select-trigger');
            const optionsContainer = rowEl.querySelector('.custom-select-options');
            
            trigger.addEventListener('click', () => {
                const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
                document.querySelectorAll('.custom-select-options').forEach(el => el.classList.add('hidden'));
                if (!isExpanded) {
                    optionsContainer.classList.remove('hidden');
                    trigger.setAttribute('aria-expanded', 'true');
                }
            });

            optionsContainer.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', () => {
                    state.id = option.dataset.id;
                    optionsContainer.classList.add('hidden');
                    trigger.setAttribute('aria-expanded', 'false');
                    render();
                    convert();
                });
            });
        });
    }

    function convert(source = 'top') {
        if (isUpdating || Object.keys(rates).length === 0) return;
        isUpdating = true;
        
        const sourceState = (source === 'top') ? appState.top : appState.bottom;
        const targetState = (source === 'top') ? appState.bottom : appState.top;
        
        const cryptoId = appState.top.type === 'crypto' ? appState.top.id : appState.bottom.id;
        const fiatId = appState.top.type === 'fiat' ? appState.top.id : appState.bottom.id;

        const rate = rates[cryptoId]?.[fiatId.toLowerCase()];
        if (!rate) { isUpdating = false; return; }

        if (sourceState.type === 'fiat') { // Fiat -> Crypto
            targetState.amount = sourceState.amount / rate;
        } else { // Crypto -> Fiat
            targetState.amount = sourceState.amount * rate;
        }

        document.getElementById('top-amount').value = formatAmount(appState.top);
        document.getElementById('bottom-amount').value = formatAmount(appState.bottom);

        updateRateInfo();
        isUpdating = false;
    }
    
    function formatAmount(state) {
        if (state.type === 'fiat') return state.amount.toFixed(2);
        // Affiche plus de décimales pour les cryptos
        return parseFloat(state.amount.toPrecision(6)); 
    }

    function updateRateInfo() {
        const cryptoState = appState.top.type === 'crypto' ? appState.top : appState.bottom;
        const fiatState = appState.top.type === 'fiat' ? appState.top : appState.bottom;
        const rate = rates[cryptoState.id]?.[fiatState.id.toLowerCase()];
        if (rate) {
            const cryptoSymbol = CRYPTOS[cryptoState.id] ? CRYPTOS[cryptoState.id].symbol : '';
            rateInfo.textContent = `1 ${cryptoSymbol} = ${rate.toLocaleString('fr-FR', { style: 'currency', currency: fiatState.id, maximumFractionDigits: rate < 1 ? 6 : 2 })}`;
        }
    }
    
    swapBtn.addEventListener('click', () => {
        [appState.top, appState.bottom] = [appState.bottom, appState.top];
        render();
        convert();
    });
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select-wrapper')) {
            document.querySelectorAll('.custom-select-options').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.custom-select-trigger').forEach(el => el.setAttribute('aria-expanded', 'false'));
        }
    });

    fetchRates();
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
