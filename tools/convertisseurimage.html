<!DOCTYPE html>
<html lang="fr" data-app="laruche">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convertisseur d'Images — La Ruche</title>
  <meta name="description" content="Convertissez facilement vos images aux formats PNG, JPG, WEBP, GIF, BMP, AVIF, SVG, ICO et plus, directement dans votre navigateur.">

  <style>
    :root {
      --color-bg: #FFFFFF;
      --color-bg-alt: #F7F8FA;
      --color-border: #E9EAF0;
      --color-text-primary: #141417;
      --color-text-secondary: #6B7280;
      --color-violet: #7C3AED;
      --color-violet-dark: #6D28D9;
      --radius-md: 12px;
      --radius-lg: 14px;
      --tool-max-w: 480px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; background-color: var(--color-bg); }
    body {
      height: 100vh; overflow: hidden; display: flex; flex-direction: column;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--color-text-primary); line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    body[data-size="default"] { --tool-max-w: 480px; }
    body[data-size="wide"] { --tool-max-w: 960px; }
    body[data-size="xl"] { --tool-max-w: 1200px; }

    #bg-canvas { position: fixed; inset: 0; width: 100%; height: 100%; z-index: -1; }

    .app-header {
      flex-shrink: 0; background: var(--color-bg-alt); border-bottom: 1px solid var(--color-border);
      padding: 0 24px; display: flex; align-items: center; height: 70px;
    }
    .app-header a { display: inline-flex; align-items: center; }
    .logo-img { height: 70px; width: auto; vertical-align: middle; }

    .main-content {
      flex-grow: 1; display: flex; align-items: center; justify-content: center;
      padding: 48px 24px; overflow-y: auto;
    }
    .tool-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; width: 100%; }
    .tool-title {
      font-size: 1.75rem; font-weight: 600; padding: 12px 28px;
      background: linear-gradient(45deg, var(--color-violet), var(--color-violet-dark));
      color: #fff; border-radius: var(--radius-md); margin-bottom: -20px; position: relative; z-index: 5;
      box-shadow: 0 4px 14px -4px rgba(124, 58, 237, .4);
    }
    .generator-card {
      background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-lg);
      padding: 28px; padding-top: 40px; width: 100%; max-width: var(--tool-max-w);
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      display: flex; flex-direction: column; gap: 20px;
    }
    
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      font-weight: 500; padding: 10px 16px; border-radius: var(--radius-md); border: 1px solid var(--color-border);
      cursor: pointer; transition: background-color .2s, box-shadow .2s, border-color .2s, color .2s; font-size: 14px;
      background: var(--color-bg); color: var(--color-text-primary);
    }
    .btn:hover:not(:disabled) { border-color: var(--color-violet); background: var(--color-bg-alt); }
    .btn:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 3px rgba(124, 58, 237, .4); }
    .btn-primary { background: var(--color-violet); color: #fff; border-color: var(--color-violet); }
    .btn-primary:hover:not(:disabled) { background: var(--color-violet-dark); border-color: var(--color-violet-dark); }
    .btn-primary:disabled { background: #A78BFA; cursor: not-allowed; border-color: #A78BFA; }

    /* Styles spécifiques à l'outil */
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-label { font-weight: 500; color: var(--color-text-primary); }

    .file-info-bar {
      display: flex; align-items: center; gap: 10px;
      background-color: var(--color-bg-alt); padding: 10px 14px;
      border-radius: var(--radius-md); border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
    }
    .file-info-bar svg { width: 20px; height: 20px; color: var(--color-violet); flex-shrink: 0; }
    #file-name-display {
      font-weight: 500; color: var(--color-text-primary);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .format-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
    .format-btn.selected {
      background: var(--color-violet); color: #fff; border-color: var(--color-violet);
    }
    .format-btn.selected:hover:not(:disabled) {
      background: var(--color-violet-dark); border-color: var(--color-violet-dark);
    }
    
    .actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 4px; }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body data-size="default">
  <canvas id="bg-canvas"></canvas>

  <header class="app-header">
    <a href="/" aria-label="Accueil">
      <img src="logo-2.png" alt="Logo La Ruche" class="logo-img">
    </a>
  </header>

  <main class="main-content">
    <div class="tool-wrapper">
      <h1 class="tool-title">Convertisseur d'Images</h1>

      <div class="generator-card" role="region" aria-label="Convertisseur d'Images">
        
        <div id="initial-state">
          <button id="browse-btn" class="btn btn-primary" style="width: 100%; padding: 12px;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
            </svg>
            <span>Importer une image</span>
          </button>
          <input type="file" id="file-input" hidden accept="image/png, image/jpeg, image/webp, image/gif, image/bmp, image/avif, image/svg+xml">
        </div>

        <div id="loaded-state" hidden>
          <div class="file-info-bar">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
            <span id="file-name-display"></span>
          </div>
          <div class="form-group">
            <label class="form-label">Convertir en :</label>
            <div id="format-selection" class="format-buttons">
              <!-- Les boutons de format seront injectés ici par JS -->
            </div>
          </div>
          <div class="actions">
            <button id="reset-btn" class="btn">Changer</button>
            <button id="convert-btn" class="btn btn-primary" disabled>Exporter</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Background hex grid
    (function(){
      const c = document.getElementById('bg-canvas'); if(!c) return;
      const ctx = c.getContext('2d');
      function draw(){
        const dpr = window.devicePixelRatio || 1; const rect = c.getBoundingClientRect();
        c.width = rect.width * dpr; c.height = rect.height * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,rect.width,rect.height);
        const size = 24, hexW = 2 * size, hexH = Math.sqrt(3) * size, stepX = hexW * 3/4;
        ctx.strokeStyle = 'rgba(124,58,237,0.10)'; ctx.lineWidth = 1;
        for(let row=0; row*hexH < rect.height + hexH; row++){
          for(let col=0; col*stepX < rect.width + hexW; col++){
            const x = col * stepX, y = row * hexH + (col % 2 ? hexH/2 : 0);
            ctx.beginPath();
            for(let i=0;i<6;i++){
              const a = 2 * Math.PI / 6 * i, px = x + size * Math.cos(a), py = y + size * Math.sin(a);
              if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
            }
            ctx.closePath(); ctx.stroke();
          }
        }
      }
      window.addEventListener('resize', draw, {passive:true}); draw();
    })();

    // Outil Convertisseur d'Images
    document.addEventListener('DOMContentLoaded', () => {
      const initialStateDiv = document.getElementById('initial-state');
      const loadedStateDiv = document.getElementById('loaded-state');
      const fileInput = document.getElementById('file-input');
      const browseBtn = document.getElementById('browse-btn');
      const resetBtn = document.getElementById('reset-btn');
      const convertBtn = document.getElementById('convert-btn');
      const formatSelectionContainer = document.getElementById('format-selection');
      const fileNameDisplay = document.getElementById('file-name-display');

      const FORMATS = [
          { name: 'PNG', mime: 'image/png' },
          { name: 'JPG', mime: 'image/jpeg' },
          { name: 'WEBP', mime: 'image/webp' },
          { name: 'GIF', mime: 'image/gif' },
          { name: 'BMP', mime: 'image/bmp' },
          { name: 'AVIF', mime: 'image/avif' },
          { name: 'SVG', mime: 'image/svg+xml' },
          { name: 'ICO (Favicon)', mime: 'image/x-icon', ext: 'ico' },
      ];

      let state = {
        file: null,
        imageElement: null,
        originalFormat: '',
        targetFormat: null,
      };

      // --- Event Listeners ---
      browseBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
      resetBtn.addEventListener('click', resetUI);
      convertBtn.addEventListener('click', convertAndDownload);
      
      formatSelectionContainer.addEventListener('click', (e) => {
        const target = e.target.closest('.format-btn');
        if (target) {
            document.querySelectorAll('.format-btn.selected').forEach(btn => btn.classList.remove('selected'));
            target.classList.add('selected');
            
            const selectedFormatName = target.dataset.format;
            state.targetFormat = FORMATS.find(f => f.name === selectedFormatName);
            convertBtn.disabled = false;
        }
      });

      // --- Functions ---
      function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) return;
        
        state.file = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            state.imageElement = img;
            state.originalFormat = getFormatFromMime(file.type).toUpperCase();
            showLoadedState();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      function getFormatFromMime(mimeType) {
        const mimeMap = { 'jpeg': 'jpg', 'svg+xml': 'svg' };
        const subtype = mimeType.split('/')[1];
        return mimeMap[subtype] || subtype;
      }

      function showLoadedState() {
        initialStateDiv.hidden = true;
        loadedStateDiv.hidden = false;
        
        fileNameDisplay.textContent = state.file.name;
        populateFormatOptions();
      }
      
      function populateFormatOptions() {
          formatSelectionContainer.innerHTML = '';
          FORMATS.forEach(format => {
              if (format.name.startsWith(state.originalFormat)) return;
              const button = document.createElement('button');
              button.className = 'btn format-btn';
              button.dataset.format = format.name;
              button.textContent = format.name;
              formatSelectionContainer.appendChild(button);
          });
      }
      
      async function convertAndDownload() {
        if (!state.targetFormat || !state.imageElement) return;

        convertBtn.disabled = true;
        const originalText = convertBtn.textContent;
        convertBtn.textContent = '...';

        try {
          if (state.targetFormat.mime === 'image/svg+xml') {
            const dataURL = state.imageElement.src;
            const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="${state.imageElement.naturalWidth}" height="${state.imageElement.naturalHeight}"><image href="${dataURL}" width="100%" height="100%" /></svg>`;
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            downloadBlob(blob);
          } else if (state.targetFormat.mime === 'image/x-icon') {
            const blob = await createIcoBlob(state.imageElement);
            downloadBlob(blob, 'favicon.ico');
          } else {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = state.imageElement.naturalWidth;
            canvas.height = state.imageElement.naturalHeight;

            if (state.targetFormat.mime === 'image/jpeg' || state.targetFormat.mime === 'image/bmp') {
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            ctx.drawImage(state.imageElement, 0, 0);
            
            const blob = await new Promise(resolve => canvas.toBlob(resolve, state.targetFormat.mime, 0.95));
            downloadBlob(blob);
          }
        } catch (error) {
            console.error("Conversion failed:", error);
            alert("Une erreur est survenue pendant la conversion.");
        } finally {
            convertBtn.disabled = false;
            convertBtn.textContent = originalText;
        }
      }

      function downloadBlob(blob, customName) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        let fileName;

        if (customName) {
            fileName = customName;
        } else {
            const newExtension = (state.targetFormat.ext || state.targetFormat.name).toLowerCase();
            const originalName = state.file.name.substring(0, state.file.name.lastIndexOf('.'));
            fileName = `${originalName}.${newExtension}`;
        }

        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      async function createIcoBlob(imageElement) {
        const size = 32;
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(imageElement, 0, 0, size, size);

        const pngBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const pngBuffer = await pngBlob.arrayBuffer();

        const header = new Uint8Array([0, 0, 1, 0, 1, 0]);
        const dir = new DataView(new ArrayBuffer(16));
        dir.setUint8(0, size);      // Width
        dir.setUint8(1, size);      // Height
        dir.setUint8(2, 0);         // Color Palette
        dir.setUint16(4, 1, true);  // Color Planes
        dir.setUint16(6, 32, true); // Bits per Pixel
        dir.setUint32(8, pngBlob.size, true); // Size of Data
        dir.setUint32(12, 22, true);          // Offset to Data (6 header + 16 dir)
        
        const icoBuffer = new Uint8Array(22 + pngBuffer.byteLength);
        icoBuffer.set(header, 0);
        icoBuffer.set(new Uint8Array(dir.buffer), 6);
        icoBuffer.set(new Uint8Array(pngBuffer), 22);

        return new Blob([icoBuffer], { type: 'image/x-icon' });
      }

      function resetUI() {
        initialStateDiv.hidden = false;
        loadedStateDiv.hidden = true;
        
        fileInput.value = '';
        state = { file: null, imageElement: null, originalFormat: '', targetFormat: null };
        convertBtn.disabled = true;
        formatSelectionContainer.innerHTML = '';
      }
    });
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
