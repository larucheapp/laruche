<!DOCTYPE html>
<html lang="fr" data-app="laruche">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planificateur d'Équipe — La Ruche</title>
  <meta name="description" content="Organisez l'emploi du temps de votre équipe avec un outil de planification visuel. Glissez-déposez, ajustez les horaires et exportez en PDF.">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --color-bg: #FFFFFF;
      --color-bg-alt: #F7F8FA;
      --color-border: #E9EAF0;
      --color-text-primary: #141417;
      --color-text-secondary: #6B7280;
      --color-violet: #7C3AED;
      --color-violet-dark: #6D28D9;
      --radius-md: 12px;
      --radius-lg: 14px;
      --tool-max-w: 480px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; background-color: var(--color-bg); }
    body {
      height: 100vh; overflow: hidden; display: flex; flex-direction: column;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--color-text-primary); line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    body[data-size="default"] { --tool-max-w: 480px; }
    body[data-size="wide"] { --tool-max-w: 960px; }
    body[data-size="xl"] { --tool-max-w: 1200px; }

    #bg-canvas { position: fixed; inset: 0; width: 100%; height: 100%; z-index: -1; }

    .app-header {
      flex-shrink: 0; background: var(--color-bg-alt); border-bottom: 1px solid var(--color-border);
      padding: 0 24px; display: flex; align-items: center; height: 70px;
    }
    .app-header a { display: inline-flex; align-items: center; }
    .logo-img { height: 70px; width: auto; vertical-align: middle; }

    .main-content {
      flex-grow: 1; display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 48px 24px; overflow: auto;
    }
    .tool-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; width:100%; max-width: var(--tool-max-w); }
    .tool-title {
      font-size: 1.75rem; font-weight: 600; padding: 12px 28px;
      background: linear-gradient(45deg, var(--color-violet), var(--color-violet-dark));
      color: #fff; border-radius: var(--radius-md); margin-bottom: -20px; position: relative; z-index: 10;
      box-shadow: 0 4px 14px -4px rgba(124, 58, 237, .4);
    }
    .generator-card {
      background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-lg);
      padding: 28px; padding-top: 40px; width: 100%;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      display: flex; flex-direction: column; gap: 24px;
    }

    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-label { font-weight: 500; color: var(--color-text-primary); }
    .form-input {
      width: 100%; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md);
      font-size: 1rem; color: var(--color-text-primary); background: var(--color-bg);
      transition: border-color .2s, box-shadow .2s;
    }
    .form-input:focus { outline: none; border-color: var(--color-violet); box-shadow: 0 0 0 3px rgba(124, 58, 237, .2); }
    .form-input[type="color"] { padding: 4px; height: 44px; }
    
    .actions { display: flex; justify-content: flex-end; align-items: center; gap: 12px; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      font-weight: 500; padding: 10px 16px; border-radius: var(--radius-md); border: none; cursor:pointer;
      transition: background-color .2s, box-shadow .2s; font-size: 14px;
    }
    .btn:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 3px rgba(124, 58, 237, .4); }
    .btn-primary { background: var(--color-violet); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--color-violet-dark); }
    .btn-primary:disabled { background: #A78BFA; cursor: not-allowed; }
    .btn-secondary { background: var(--color-bg-alt); color: var(--color-text-secondary); border: 1px solid var(--color-border); }
    .btn-secondary:hover:not(:disabled) { background: #F0F1F3; }

    /* --- STYLES SPÉCIFIQUES --- */
    .planner-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 24px;
        padding-top: 0;
    }
    .panel {
        padding: 0;
        padding-top: 40px;
    }
    .panel-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--color-border);
    }
    #add-employee-form { display: flex; flex-direction: column; gap: 16px; }
    #employee-list {
        display: flex; flex-direction: column; gap: 10px;
        max-height: 400px; overflow-y: auto; padding-right: 8px;
    }
    .employee-item {
        display: flex; align-items: center; gap: 12px;
        padding: 10px; border-radius: var(--radius-md);
        background: var(--color-bg-alt); border: 1px solid var(--color-border);
        cursor: grab; transition: background-color .2s, box-shadow .2s;
    }
    .employee-item:active { cursor: grabbing; background-color: #F0F1F3; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 10%), 0 2px 4px -2px rgb(0 0 0 / 10%); }
    .employee-color-swatch {
        width: 24px; height: 24px; border-radius: 50%;
        border: 2px solid rgba(0,0,0,0.1);
        flex-shrink: 0;
    }
    .employee-name { font-weight: 500; flex-grow: 1; }
    
    #schedule-panel { position: relative; }
    #schedule-container {
        display: grid;
        grid-template-columns: 50px repeat(7, 1fr);
        position: relative;
        background-color: var(--color-bg);
        border-radius: var(--radius-md);
    }
    .timeline {
        grid-column: 1 / 2;
        padding-top: 30px; /* Offset for day headers */
    }
    .time-label {
        height: 60px; /* Corresponds to 1 hour */
        font-size: 12px;
        color: var(--color-text-secondary);
        text-align: right;
        padding-right: 10px;
        position: relative;
    }
    .time-label::after {
        content: ''; position: absolute; top: 0; right: 0; width: 5px; height: 1px;
        background-color: var(--color-border);
    }
    .day-column {
        position: relative;
        border-left: 1px solid var(--color-border);
        background-image: linear-gradient(var(--color-border) 1px, transparent 1px);
        background-size: 100% 60px; /* 1-hour grid lines */
    }
    .day-header {
        text-align: center; font-weight: 500; font-size: 14px;
        padding: 8px 0; position: sticky; top: 0;
        background-color: var(--color-bg);
        border-bottom: 1px solid var(--color-border);
    }
    .day-column.drag-over {
      background-color: rgba(124, 58, 237, 0.05);
    }
    .task-item {
        position: absolute;
        /* left/right/width are now set dynamically by JS */
        border-radius: var(--radius-md);
        padding: 8px;
        font-size: 13px; font-weight: 500; color: #fff;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        cursor: grab;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        user-select: none;
        transition: height 0.2s ease-in-out, left 0.2s ease-in-out, width 0.2s ease-in-out, right 0.2s ease-in-out;
    }
    .task-item:active { cursor: grabbing; filter: brightness(1.1); z-index: 10; }

    .planner-actions { padding: 16px 0 0; }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body data-size="xl">
  <canvas id="bg-canvas"></canvas>

  <header class="app-header">
    <a href="/" aria-label="Accueil">
      <img src="logo-2.png" alt="Logo La Ruche" class="logo-img">
    </a>
  </header>

  <main class="main-content">
    <div class="tool-wrapper">
      <h1 class="tool-title">Planificateur d'Équipe</h1>
      
      <div class="generator-card planner-layout" role="region" aria-label="Planificateur d'Équipe">
        <div class="panel" id="team-panel">
            <h2 class="panel-title">Équipe</h2>
            <form id="add-employee-form">
                <div class="form-group">
                    <label for="employee-name" class="form-label">Nom de l'employé</label>
                    <input type="text" id="employee-name" class="form-input" placeholder="Ex: Alice Martin" required>
                </div>
                <div class="form-group">
                    <label for="employee-color" class="form-label">Couleur</label>
                    <input type="color" id="employee-color" class="form-input" value="#7C3AED">
                </div>
                <button type="submit" class="btn btn-primary">Ajouter à l'équipe</button>
            </form>
            <div id="employee-list-wrapper" style="margin-top: 24px;">
                <h3 class="form-label" style="margin-bottom: 12px;">Employés</h3>
                <div id="employee-list" aria-live="polite">
                  <p class="status-text">Ajoutez votre premier employé.</p>
                </div>
            </div>
        </div>

        <div class="panel" id="schedule-panel">
            <div class="actions planner-actions">
              <button id="reset-btn" class="btn btn-secondary">Réinitialiser</button>
              <button id="export-pdf-btn" class="btn btn-primary">Exporter en PDF</button>
            </div>
            <div id="schedule-container-for-pdf">
              <div id="schedule-container">
                  <div class="timeline"></div>
                  <div class="day-column" data-day="Lundi"><div class="day-header">Lundi</div></div>
                  <div class="day-column" data-day="Mardi"><div class="day-header">Mardi</div></div>
                  <div class="day-column" data-day="Mercredi"><div class="day-header">Mercredi</div></div>
                  <div class="day-column" data-day="Jeudi"><div class="day-header">Jeudi</div></div>
                  <div class="day-column" data-day="Vendredi"><div class="day-header">Vendredi</div></div>
                  <div class="day-column" data-day="Samedi"><div class="day-header">Samedi</div></div>
                  <div class="day-column" data-day="Dimanche"><div class="day-header">Dimanche</div></div>
              </div>
            </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG ---
        const HOUR_HEIGHT = 60; // px per hour
        const START_HOUR = 7;
        const END_HOUR = 20;

        // --- DOM ELEMENTS ---
        const addEmployeeForm = document.getElementById('add-employee-form');
        const employeeNameInput = document.getElementById('employee-name');
        const employeeColorInput = document.getElementById('employee-color');
        const employeeList = document.getElementById('employee-list');
        const dayColumns = document.querySelectorAll('.day-column');
        const timeline = document.querySelector('.timeline');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const resetBtn = document.getElementById('reset-btn');

        // --- STATE ---
        let employees = [];
        let tasks = [];
        let nextEmployeeId = 1;
        let nextTaskId = 1;
        let draggedEmployeeId = null;

        // --- FUNCTIONS ---
        const generateTimeline = () => {
            timeline.innerHTML = '';
            for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = `${String(hour).padStart(2, '0')}:00`;
                timeline.appendChild(timeLabel);
            }
        };

        const renderEmployees = () => {
            employeeList.innerHTML = '';
            if (employees.length === 0) {
              employeeList.innerHTML = '<p class="status-text">Ajoutez votre premier employé.</p>';
              return;
            }
            employees.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'employee-item';
                item.draggable = true;
                item.dataset.employeeId = emp.id;
                item.innerHTML = `
                    <div class="employee-color-swatch" style="background-color: ${emp.color};"></div>
                    <span class="employee-name">${emp.name}</span>
                `;
                item.addEventListener('dragstart', handleEmployeeDragStart);
                employeeList.appendChild(item);
            });
        };

        const getOverlappingTasks = (targetTask, sourceTasks) => {
            return sourceTasks.filter(task => {
                if (task.id === targetTask.id || task.day !== targetTask.day) {
                    return false;
                }
                const targetStart = targetTask.start;
                const targetEnd = targetTask.start + targetTask.duration;
                const taskStart = task.start;
                const taskEnd = task.start + task.duration;
                return targetStart < taskEnd && targetEnd > taskStart;
            });
        };

        const renderTasks = () => {
            document.querySelectorAll('.task-item').forEach(el => el.remove());
            tasks.forEach(task => {
                const employee = employees.find(e => e.id === task.employeeId);
                if (!employee) return;

                const taskEl = document.createElement('div');
                taskEl.className = 'task-item';
                taskEl.dataset.taskId = task.id;
                taskEl.style.top = `${(task.start - START_HOUR) * HOUR_HEIGHT}px`;
                taskEl.style.height = `${task.duration * HOUR_HEIGHT}px`;
                taskEl.style.backgroundColor = employee.color;
                taskEl.textContent = employee.name;
                taskEl.draggable = true;

                // Handle visual overlapping
                const overlappingPeers = getOverlappingTasks(task, tasks);
                if (overlappingPeers.length === 1) { // Max 2, so only 1 peer is possible
                    const peer = overlappingPeers[0];
                    if (task.id < peer.id) {
                        taskEl.style.left = '4px';
                        taskEl.style.right = 'calc(50% + 2px)';
                    } else {
                        taskEl.style.left = 'calc(50% + 2px)';
                        taskEl.style.right = '4px';
                    }
                } else {
                    taskEl.style.left = '4px';
                    taskEl.style.right = '4px';
                }

                taskEl.addEventListener('dragstart', handleTaskDragStart);
                
                let clickTimer = null;
                taskEl.addEventListener('click', () => {
                    if (clickTimer === null) {
                        clickTimer = setTimeout(() => {
                            clickTimer = null;
                            const durationSequence = [2, 4, 6, 8, 1];
                            const currentIndex = durationSequence.indexOf(task.duration);
                            const nextIndex = (currentIndex === -1) ? 0 : (currentIndex + 1) % durationSequence.length;
                            const newDuration = durationSequence[nextIndex];
                            
                            const potentialTask = { ...task, duration: newDuration };
                            const sourceTasksForCheck = tasks.filter(t => t.id !== task.id);
                            const overlaps = getOverlappingTasks(potentialTask, sourceTasksForCheck);

                            if (overlaps.length >= 2) {
                                alert("Impossible de redimensionner : le créneau est déjà occupé par deux personnes.");
                                return;
                            }
                            updateTask(task.id, null, undefined, newDuration);
                        }, 250);
                    }
                });
                taskEl.addEventListener('dblclick', () => {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                    removeTask(task.id);
                });

                document.querySelector(`.day-column[data-day="${task.day}"]`).appendChild(taskEl);
            });
        };

        const addTask = (employeeId, day, start) => {
            const newTask = {
                id: nextTaskId++,
                employeeId,
                day,
                start: Math.round(start * 2) / 2, // Snap to 30 mins
                duration: 2,
            };
            tasks.push(newTask);
            renderTasks();
        };
        
        const removeTask = (taskId) => {
          if (confirm("Voulez-vous vraiment supprimer cette tâche ?")) {
            tasks = tasks.filter(t => t.id !== taskId);
            renderTasks();
          }
        };

        const updateTask = (taskId, newDay, newStart, newDuration) => {
            const task = tasks.find(t => t.id === parseInt(taskId, 10));
            if (task) {
                if (newDay) task.day = newDay;
                if (newStart !== undefined) task.start = Math.max(START_HOUR, Math.round(newStart * 2) / 2);
                if (newDuration !== undefined) task.duration = newDuration;
            }
            renderTasks();
        };

        // --- EVENT HANDLERS ---
        addEmployeeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = employeeNameInput.value.trim();
            if (!name) return;
            employees.push({
                id: nextEmployeeId++,
                name: name,
                color: employeeColorInput.value
            });
            employeeNameInput.value = '';
            renderEmployees();
        });

        function handleEmployeeDragStart(e) {
            draggedEmployeeId = e.target.dataset.employeeId;
            e.dataTransfer.effectAllowed = 'copy';
        }

        function handleTaskDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => e.target.style.opacity = '0.5', 0);
        }

        dayColumns.forEach(col => {
            col.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = draggedEmployeeId ? 'copy' : 'move';
                col.classList.add('drag-over');
            });
            col.addEventListener('dragleave', (e) => {
                col.classList.remove('drag-over');
            });
            col.addEventListener('drop', (e) => {
                e.preventDefault();
                col.classList.remove('drag-over');
                const rect = col.getBoundingClientRect();
                const offsetY = e.clientY - rect.top - 30;
                const startHour = (offsetY / HOUR_HEIGHT) + START_HOUR;
                const day = col.dataset.day;

                const taskId = e.dataTransfer.getData('text/plain');
                const taskBeingMoved = taskId ? tasks.find(t => t.id === parseInt(taskId, 10)) : null;

                const potentialTask = {
                    id: taskBeingMoved ? taskBeingMoved.id : -1,
                    day: day,
                    start: Math.round(startHour * 2) / 2,
                    duration: taskBeingMoved ? taskBeingMoved.duration : 2
                };
                
                const sourceTasksForCheck = tasks.filter(t => t.id !== potentialTask.id);
                const overlaps = getOverlappingTasks(potentialTask, sourceTasksForCheck);

                if (overlaps.length >= 2) {
                    alert("Un créneau ne peut pas être occupé par plus de deux personnes.");
                    if(taskBeingMoved) {
                        document.querySelector(`.task-item[data-task-id='${taskId}']`).style.opacity = '1';
                    }
                    draggedEmployeeId = null;
                    return; 
                }

                if (taskBeingMoved) {
                    document.querySelector(`.task-item[data-task-id='${taskId}']`).style.opacity = '1';
                    updateTask(parseInt(taskId, 10), day, startHour);
                } else if (draggedEmployeeId) {
                    addTask(parseInt(draggedEmployeeId, 10), day, startHour);
                }
                draggedEmployeeId = null;
            });
        });

        exportPdfBtn.addEventListener('click', () => {
          exportPdfBtn.disabled = true;
          exportPdfBtn.textContent = 'Génération...';
          const scheduleEl = document.getElementById('schedule-container-for-pdf');
          
          // Correction : Utiliser scrollHeight pour capturer l'intégralité de l'élément,
          // même s'il n'est pas entièrement visible à l'écran.
          html2canvas(scheduleEl, { 
              scale: 2,
              height: scheduleEl.scrollHeight,
              windowHeight: scheduleEl.scrollHeight
          }).then(canvas => {
              const { jsPDF } = window.jspdf;
              const pdf = new jsPDF({
                  orientation: 'landscape',
                  unit: 'pt',
                  format: [canvas.width, canvas.height]
              });
              pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
              pdf.save('planning-equipe.pdf');
          }).catch((err) => {
              console.error("Erreur lors de l'export PDF:", err);
              alert("Une erreur est survenue lors de la génération du PDF.");
          }).finally(() => {
              exportPdfBtn.disabled = false;
              exportPdfBtn.textContent = 'Exporter en PDF';
          });
        });

        resetBtn.addEventListener('click', () => {
            if(confirm("Voulez-vous vraiment effacer le planning ? Les employés créés seront conservés.")) {
                draggedEmployeeId = null;
                tasks = [];
                nextTaskId = 1;
                renderTasks();
            }
        });

        // --- INITIALIZATION ---
        generateTimeline();
        renderEmployees();
    });

    // Background hex grid — NE PAS MODIFIER
    (function(){
      const c = document.getElementById('bg-canvas');
      const ctx = c.getContext('2d');
      function draw(){
        const dpr = window.devicePixelRatio || 1;
        const rect = c.getBoundingClientRect();
        c.width = rect.width * dpr; c.height = rect.height * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,rect.width,rect.height);
        const size = 24, hexW = 2 * size, hexH = Math.sqrt(3) * size, stepX = hexW * 3/4;
        ctx.strokeStyle = 'rgba(124,58,237,0.10)';
        ctx.lineWidth = 1;
        for(let row=0; row*hexH < rect.height + hexH; row++){
          for(let col=0; col*stepX < rect.width + hexW; col++){
            const x = col * stepX, y = row * hexH + (col % 2 ? hexH/2 : 0);
            ctx.beginPath();
            for(let i=0;i<6;i++){
              const a = 2 * Math.PI / 6 * i, px = x + size * Math.cos(a), py = y + size * Math.sin(a);
              if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
            }
            ctx.closePath(); ctx.stroke();
          }
        }
      }
      window.addEventListener('resize', draw, {passive:true});
      draw();
    })();
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
