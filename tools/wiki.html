<!DOCTYPE html>
<html lang="fr" data-app="laruche">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apis — Assistant de Connaissances — La Ruche</title>
  <meta name="description" content="Posez une question à Apis, il cherchera la réponse pour vous sur Wikipédia.">
  <style>
    :root {
      --color-bg: #FFFFFF;
      --color-bg-alt: #F7F8FA;
      --color-border: #E9EAF0;
      --color-text-primary: #141417;
      --color-text-secondary: #6B7280;
      --color-violet: #7C3AED;
      --color-violet-dark: #6D28D9;
      --radius-md: 12px;
      --radius-lg: 14px;
      --tool-max-w: 480px; /* par défaut, peut être changé via body[data-size] */
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; background-color: var(--color-bg); }
    body {
      height: 100vh; overflow: hidden; display: flex; flex-direction: column;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--color-text-primary); line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    body[data-size="default"] { --tool-max-w: 480px; }
    body[data-size="wide"] { --tool-max-w: 960px; }
    body[data-size="xl"] { --tool-max-w: 1200px; }

    #bg-canvas { position: fixed; inset: 0; width: 100%; height: 100%; z-index: -1; }

    .app-header {
      flex-shrink: 0; background: var(--color-bg-alt); border-bottom: 1px solid var(--color-border);
      padding: 0 24px; display: flex; align-items: center; height: 70px;
    }
    .app-header a { display: inline-flex; align-items: center; }
    .logo-img { height: 70px; width: auto; vertical-align: middle; }

    .main-content {
      flex-grow: 1; display: flex; align-items: center; justify-content: center;
      padding: 48px 24px; overflow-y: auto;
    }
    .tool-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; width: 100%; max-width: var(--tool-max-w); }
    .tool-title {
      font-size: 1.75rem; font-weight: 600; padding: 12px 28px;
      background: linear-gradient(45deg, var(--color-violet), var(--color-violet-dark));
      color: #fff; border-radius: var(--radius-md); margin-bottom: -20px; position: relative; z-index: 5;
      box-shadow: 0 4px 14px -4px rgba(124, 58, 237, .4);
    }
    .generator-card {
      background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-lg);
      width: 100%;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 70vh;
      max-height: 700px;
      margin-top: 20px; /* To account for title overlap */
    }
    .form-input {
      width: 100%; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md);
      font-size: 1rem; color: var(--color-text-primary); background: var(--color-bg);
      transition: border-color .2s, box-shadow .2s;
    }
    .form-input:focus { outline: none; border-color: var(--color-violet); box-shadow: 0 0 0 3px rgba(124, 58, 237, .2); }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      font-weight: 500; padding: 10px 16px; border-radius: var(--radius-md); border: none; cursor: pointer;
      transition: background-color .2s, box-shadow .2s; font-size: 14px;
    }
    .btn:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 3px rgba(124, 58, 237, .4); }
    .btn-primary { background: var(--color-violet); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--color-violet-dark); }
    .btn-primary:disabled { background: #A78BFA; cursor: not-allowed; }

    /* Chat styles */
    .chat-history {
      flex-grow: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      display: flex;
      max-width: 85%;
      align-items: flex-start;
      gap: 12px;
    }
    .message-avatar {
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
    }
    .assistant-message .message-avatar {
      background-color: var(--color-border);
      overflow: hidden;
    }
    .assistant-message .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .assistant-message .message-avatar.fallback {
      background: linear-gradient(45deg, var(--color-violet), var(--color-violet-dark));
      color: white;
    }
    .message-content {
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      line-height: 1.6;
      word-break: break-word;
    }
    .assistant-message .message-content {
      background: var(--color-bg-alt);
      border: 1px solid var(--color-border);
      color: var(--color-text-primary);
      border-top-left-radius: 4px;
    }
    .user-message {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .user-message .message-content {
      background: var(--color-violet);
      color: white;
      border-top-right-radius: 4px;
    }

    .message-content p { margin-bottom: 1em; }
    .message-content p:last-child { margin-bottom: 0; }
    
    .prompt-form-wrapper {
      padding: 16px 24px;
      border-top: 1px solid var(--color-border);
      background: var(--color-bg);
      border-bottom-left-radius: var(--radius-lg);
      border-bottom-right-radius: var(--radius-lg);
      flex-shrink: 0;
    }
    .prompt-form {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    #send-btn {
      width: 42px;
      height: 42px;
      padding: 0;
      flex-shrink: 0;
    }

    .thinking-indicator { display: flex; gap: 8px; align-items: center; padding: 12px 16px; }
    .thinking-indicator .dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--color-text-secondary);
      animation: pulse 1.4s infinite ease-in-out both;
    }
    .thinking-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
    .thinking-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes pulse { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body data-size="wide">
  <canvas id="bg-canvas"></canvas>

  <header class="app-header">
    <a href="/" aria-label="Accueil">
      <img src="logo-2.png" alt="Logo La Ruche" class="logo-img">
    </a>
  </header>

  <main class="main-content">
    <div class="tool-wrapper">
      <h1 class="tool-title">Apis Wiki</h1>

      <div class="generator-card" role="region" aria-label="Assistant Apis">
        <div id="chat-history" class="chat-history" role="log" aria-live="polite">
          <!-- Les messages seront ajoutés ici dynamiquement -->
        </div>
        <div class="prompt-form-wrapper">
          <form id="prompt-form" class="prompt-form">
            <input type="text" id="prompt-input" class="form-input" placeholder="Chercher sur Wikipédia..." autocomplete="off" required>
            <button id="send-btn" class="btn btn-primary" type="submit" aria-label="Envoyer">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/></svg>
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        const chatHistory = document.getElementById('chat-history');
        const promptForm = document.getElementById('prompt-form');
        const promptInput = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');

        const addMessage = (sender, text) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message ${sender}-message`;

            let avatarHtml = '';
            if (sender === 'assistant') {
                avatarHtml = `<div class="message-avatar">
                                <img src="apis.png" alt="Avatar d'Apis" onerror="this.parentElement.innerHTML = 'A'; this.parentElement.classList.add('fallback');">
                              </div>`;
            }

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = `<p>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
            
            messageWrapper.appendChild(messageContent);
            if (avatarHtml) messageWrapper.insertAdjacentHTML('afterbegin', avatarHtml);

            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return messageContent;
        };

        const displayResponseByWord = (element, text) => {
            const words = text.split(' ');
            let i = 0;
            element.innerHTML = ''; 
            
            const intervalId = setInterval(() => {
                if (i < words.length) {
                    element.innerHTML += (i > 0 ? ' ' : '') + words[i];
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    i++;
                } else {
                    clearInterval(intervalId);
                    // Re-enable form after streaming is complete
                    promptInput.disabled = false;
                    sendBtn.disabled = false;
                    promptInput.focus();
                }
            }, 50); // Adjust speed of typing here (milliseconds per word)
        };

        const showThinkingIndicator = () => {
            const indicatorHtml = `
              <div class="message assistant-message" id="thinking-indicator-message">
                <div class="message-avatar">
                  <img src="apis.png" alt="Avatar d'Apis" onerror="this.parentElement.innerHTML = 'A'; this.parentElement.classList.add('fallback');">
                </div>
                <div class="message-content">
                  <div class="thinking-indicator">
                      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                  </div>
                </div>
              </div>`;
            chatHistory.insertAdjacentHTML('beforeend', indicatorHtml);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        };

        const removeThinkingIndicator = () => {
            const indicator = document.getElementById('thinking-indicator-message');
            if (indicator) {
                indicator.remove();
            }
        };
        
        // Step 1: Find the most relevant Wikipedia page title for a query
        const findBestMatch = async (query) => {
            const searchEndpoint = `https://fr.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
            try {
                const response = await fetch(searchEndpoint);
                const data = await response.json();
                if (data.query.search.length > 0) {
                    return data.query.search[0].title;
                }
                return null;
            } catch (error) {
                console.error("Wikipedia Search API Error:", error);
                return null;
            }
        };

        // Step 2: Get the summary for a specific page title
        const getSummaryForPage = async (title) => {
            const summaryEndpoint = `https://fr.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
            try {
                const response = await fetch(summaryEndpoint, {
                    headers: { 'Accept': 'application/json; charset=utf-8' }
                });
                if (!response.ok) {
                    return null;
                }
                const data = await response.json();
                return data.extract;
            } catch (error) {
                console.error("Wikipedia Summary API Error:", error);
                return null;
            }
        };
        
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const prompt = promptInput.value.trim();
            if (!prompt) return;
            
            promptInput.value = '';
            promptInput.disabled = true;
            sendBtn.disabled = true;

            addMessage('user', prompt);
            showThinkingIndicator();
            
            let summary = "Désolé, je n'ai rien trouvé sur Wikipédia pour cette recherche. Essayez d'autres mots-clés.";
            
            const bestTitle = await findBestMatch(prompt);
            if (bestTitle) {
                const pageSummary = await getSummaryForPage(bestTitle);
                if (pageSummary) {
                    summary = pageSummary;
                } else {
                    summary = `J'ai trouvé un article intitulé "${bestTitle}", mais je n'ai pas pu en extraire le résumé.`;
                }
            }
            
            removeThinkingIndicator();
            const assistantMessageEl = addMessage('assistant', ''); // Add empty bubble
            displayResponseByWord(assistantMessageEl.querySelector('p'), summary); // Stream text into it
        };

        promptForm.addEventListener('submit', handleFormSubmit);

        // Initial message
        addMessage('assistant', "Bonjour ! Je suis Apis. Posez-moi une question sur un sujet, et je chercherai un résumé pour vous sur Wikipédia.");
    });

    // Background hex grid — NE PAS MODIFIER
    (function(){
      const c = document.getElementById('bg-canvas');
      const ctx = c.getContext('2d');
      function draw(){
        const dpr = window.devicePixelRatio || 1;
        const rect = c.getBoundingClientRect();
        c.width = rect.width * dpr; c.height = rect.height * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,rect.width,rect.height);
        const size = 24, hexW = 2 * size, hexH = Math.sqrt(3) * size, stepX = hexW * 3/4;
        ctx.strokeStyle = 'rgba(124,58,237,0.10)'; ctx.lineWidth = 1;
        for(let row=0; row*hexH < rect.height + hexH; row++){
          for(let col=0; col*stepX < rect.width + hexW; col++){
            const x = col * stepX, y = row * hexH + (col % 2 ? hexH/2 : 0);
            ctx.beginPath();
            for(let i=0;i<6;i++){
              const a = 2 * Math.PI / 6 * i, px = x + size * Math.cos(a), py = y + size * Math.sin(a);
              if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
            }
            ctx.closePath(); ctx.stroke();
          }
        }
      }
      window.addEventListener('resize', draw, {passive:true});
      draw();
    })();
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
