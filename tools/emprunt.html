<!DOCTYPE html>
<html lang="fr" data-app="laruche" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculateur d'Emprunt</title>
  <meta name="description" content="Simulez facilement vos mensualités, le coût total et les intérêts de votre prêt immobilier ou consommation.">
  <!-- jsPDF pour l'export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <style>
    :root{
      --color-bg:#FFFFFF;
      --color-bg-alt:#F7F8FA;
      --color-border:#E9EAF0;
      --color-text-primary:#141417;
      --color-text-secondary:#6B7280;
      --color-violet:#7C3AED;
      --color-violet-dark:#6D28D9;
      --color-green:#10B981;
      --radius-md:12px;
      --radius-lg:14px;
      --tool-max-w:480px; /* par défaut, peut être changé via body[data-size] */
    }

    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{height:100%;background-color:var(--color-bg)}
    body{
      height:100vh; overflow:hidden; display:flex; flex-direction:column;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Inter",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--color-text-primary); line-height:1.5; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body[data-size="default"]{--tool-max-w:480px}
    body[data-size="wide"]{--tool-max-w:960px}
    body[data-size="xl"]{--tool-max-w:1200px}

    #bg-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:-1}

    .app-header{
      flex-shrink:0; background:var(--color-bg-alt); border-bottom:1px solid var(--color-border);
      padding:0 24px; display:flex; align-items:center; height:70px;
    }
    .app-header a{display:inline-flex; align-items:center}
    .logo-img{height:70px; width:auto; vertical-align:middle}

    .main-content{
      flex-grow:1; display:flex; align-items:center; justify-content:center;
      padding:48px 24px; overflow-y:auto;
    }
    .tool-wrapper{display:flex; flex-direction:column; align-items:center; position:relative}
    .tool-title{
      font-size:1.75rem; font-weight:600; padding:12px 28px;
      background:linear-gradient(45deg,var(--color-violet),var(--color-violet-dark));
      color:#fff; border-radius:var(--radius-md); margin-bottom:-20px; position:relative; z-index:5;
      box-shadow:0 4px 14px -4px rgba(124,58,237,.4);
    }
    .generator-card{
      background:var(--color-bg); border:1px solid var(--color-border); border-radius:var(--radius-lg);
      padding:28px; padding-top:40px; width:100%; max-width:var(--tool-max-w);
      box-shadow:0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      display:flex; flex-direction:column; gap:24px;
    }
    .form-group{display:flex; flex-direction:column; gap:8px}
    .form-label{font-weight:500; color:var(--color-text-primary); display: flex; align-items: center; gap: 8px;}
    .form-label svg { width: 20px; height: 20px; color: var(--color-violet); }
    .input-row { display: flex; align-items: center; gap: 12px; }
    .form-input{
      padding:10px 14px; border:1px solid var(--color-border); border-radius:var(--radius-md);
      font-size:1rem; color:var(--color-text-primary); background:var(--color-bg);
      transition:border-color .2s, box-shadow .2s;
    }
    .form-input[type="number"] { width: 120px; text-align: right; }
    .form-input:focus{outline:none; border-color:var(--color-violet); box-shadow:0 0 0 3px rgba(124,58,237,.2)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      font-weight:500; padding:10px 16px; border-radius:var(--radius-md); border:none; cursor:pointer;
      transition:background-color .2s, box-shadow .2s, opacity .2s; font-size:14px;
    }
    .btn:focus-visible{outline:2px solid transparent; outline-offset:2px; box-shadow:0 0 0 3px rgba(124,58,237,.4)}
    .btn-primary{background:var(--color-violet); color:#fff}
    .btn-primary:hover:not(:disabled){background:var(--color-violet-dark)}
    .btn-primary:disabled{background:#A78BFA; cursor:not-allowed; opacity: 0.7;}

    /* Keyframe for thumb pulse animation */
    @keyframes thumb-pulse {
      0% { box-shadow: 0 2px 5px rgba(0,0,0,0.15), 0 0 0 0px rgba(124, 58, 237, 0.5); }
      100% { box-shadow: 0 2px 5px rgba(0,0,0,0.15), 0 0 0 10px rgba(124, 58, 237, 0); }
    }

    /* Base styles for the slider */
    input[type="range"] {
      flex-grow: 1;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
      height: 24px; /* Give room for thumb */
    }
    input[type="range"]:focus { outline: none; }

    /***** Track Styles *****/
    input[type="range"]::-webkit-slider-runnable-track {
      width: 100%;
      height: 12px;
      background: linear-gradient(to right, var(--color-violet) var(--fill-percent, 0%), var(--color-border) var(--fill-percent, 0%));
      border-radius: var(--radius-md);
    }
    input[type="range"]::-moz-range-track {
      width: 100%;
      height: 12px;
      background: var(--color-border);
      border-radius: var(--radius-md);
    }
    input[type="range"]::-moz-range-progress {
      background-color: var(--color-violet);
      height: 12px;
      border-radius: var(--radius-md);
    }

    /***** Thumb Styles *****/
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      margin-top: -6px; /* (12px track - 24px thumb) / 2 */
      height: 24px;
      width: 24px;
      background-color: var(--color-violet);
      border: 4px solid #fff;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      transition: transform .2s ease;
      animation: thumb-pulse 1.5s infinite;
    }
    input[type="range"]::-moz-range-thumb {
      height: 24px;
      width: 24px;
      background-color: var(--color-violet);
      border: 4px solid #fff;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      transition: transform .2s ease;
      border: none;
      animation: thumb-pulse 1.5s infinite;
    }
    
    /* Active/Hover State */
    input[type="range"]:active::-webkit-slider-thumb, input[type="range"]:hover::-webkit-slider-thumb {
      transform: scale(1.1);
    }
    input[type="range"]:active::-moz-range-thumb, input[type="range"]:hover::-moz-range-thumb {
      transform: scale(1.1);
    }
    
    /* Focus state */
    input[type="range"]:focus-visible::-webkit-slider-thumb {
       border-color: #fff;
       box-shadow: 0 0 0 3px var(--color-bg), 0 0 0 5px var(--color-violet);
       animation: none; /* Turn off pulse when focusing for clarity */
    }
    input[type="range"]:focus-visible::-moz-range-thumb {
       box-shadow: 0 0 0 3px var(--color-bg), 0 0 0 5px var(--color-violet);
       animation: none;
    }

    /* Styles spécifiques au calculateur d'emprunt */
    .loan-calculator-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      align-items: flex-start;
    }
    .results-panel {
      background-color: var(--color-bg-alt);
      border-radius: var(--radius-lg);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .results-panel h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
      color: var(--color-text-primary);
      text-align: center;
    }
    .monthly-payment { text-align: center; }
    .monthly-payment-label { color: var(--color-text-secondary); font-size: 1rem; }
    .monthly-payment-value { 
      color: var(--color-violet); 
      font-size: 2.5rem; 
      font-weight: 600; 
      line-height: 1.2;
    }
    .cost-breakdown { display: flex; flex-direction: column; gap: 10px; }
    .cost-item { display: flex; justify-content: space-between; font-size: 0.95rem; }
    .cost-item .label { color: var(--color-text-secondary); }
    .cost-item .value { font-weight: 500; }

    .chart-container { position: relative; width: 120px; height: 120px; margin: 10px auto; }
    .pie-chart { width: 100%; height: 100%; border-radius: 50%; }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body data-size="wide">
  <canvas id="bg-canvas"></canvas>

  <header class="app-header">
    <a href="index.html" aria-label="Accueil">
      <img src="logo-2.png" alt="Logo La Ruche" class="logo-img">
    </a>
  </header>

  <main class="main-content">
    <div class="tool-wrapper">
      <h1 class="tool-title">Calculateur d'Emprunt</h1>

      <!-- ZONE OUTIL -->
      <div class="generator-card" role="region" aria-label="Calculateur d'Emprunt">
        <div class="loan-calculator-layout">
          
          <div class="inputs-panel">
            <div class="form-group">
              <label for="loanAmount" class="form-label">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 0 0-2.25-2.25H15a3 3 0 1 1-6 0H5.25A2.25 2.25 0 0 0 3 12m18 0v6a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 18v-6m18 0a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 12m15 0a2.25 2.25 0 0 1 2.25 2.25v6a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 18v-6m15-9.75a2.25 2.25 0 0 1 2.25 2.25v.008a2.25 2.25 0 0 1-2.25 2.25h-3.375a3 3 0 0 1-5.25 0H5.25a2.25 2.25 0 0 1-2.25-2.25v-.008a2.25 2.25 0 0 1 2.25-2.25h13.5Z" /></svg>
                Montant de l'emprunt
              </label>
              <input type="range" id="loanAmountSlider" min="1000" max="500000" step="1000" value="150000">
              <div class="input-row">
                <input type="number" id="loanAmount" class="form-input" min="1000" max="500000" step="1000" value="150000">
                <span>€</span>
              </div>
            </div>
            
            <div class="form-group">
              <label for="interestRate" class="form-label">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75c0-1.036.84-1.875 1.875-1.875h.375a1.875 1.875 0 0 1 0 3.75h-.375A1.875 1.875 0 0 1 9.75 9.75ZM19.5 9.75c0-1.036.84-1.875 1.875-1.875h.375a1.875 1.875 0 0 1 0 3.75h-.375A1.875 1.875 0 0 1 19.5 9.75ZM4.5 19.5a2.25 2.25 0 0 1-2.25-2.25V6.75A2.25 2.25 0 0 1 4.5 4.5h15A2.25 2.25 0 0 1 21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15Z" /></svg>
                Taux d'intérêt annuel
              </label>
              <input type="range" id="interestRateSlider" min="0.1" max="10" step="0.01" value="1.75">
              <div class="input-row">
                <input type="number" id="interestRate" class="form-input" min="0.1" max="10" step="0.01" value="1.75">
                <span>%</span>
              </div>
            </div>

            <div class="form-group">
              <label for="loanTerm" class="form-label">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Zm0 4.5h.008v.008H12v-.008Zm4.5-4.5h.008v.008H16.5v-.008Zm0 4.5h.008v.008H16.5v-.008Zm-9-4.5h.008v.008H7.5v-.008Zm0 4.5h.008v.008H7.5v-.008Z" /></svg>
                Durée du prêt (années)
              </label>
              <input type="range" id="loanTermSlider" min="1" max="30" step="1" value="20">
              <div class="input-row">
                 <input type="number" id="loanTerm" class="form-input" min="1" max="30" step="1" value="20">
                 <span>ans</span>
              </div>
            </div>
          </div>
          
          <div class="results-panel">
            <h2>Votre simulation</h2>
            <div class="monthly-payment">
              <div class="monthly-payment-label">Mensualité estimée</div>
              <div id="monthlyPaymentValue" class="monthly-payment-value">0,00 €</div>
            </div>
             <div class="chart-container">
                <div id="pieChart" class="pie-chart"></div>
            </div>
            <div class="cost-breakdown">
              <div class="cost-item">
                <span class="label">Coût total du crédit</span>
                <span id="totalInterestValue" class="value">0,00 €</span>
              </div>
              <div class="cost-item">
                <span class="label">Montant total remboursé</span>
                <span id="totalCostValue" class="value">0,00 €</span>
              </div>
            </div>
            <button id="exportPdfBtn" class="btn btn-primary" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
              Exporter en PDF
            </button>
          </div>

        </div>
      </div>
      <!-- /ZONE OUTIL -->
    </div>
  </main>

  <script>
    // Background hex grid
    (function(){
      const c = document.getElementById('bg-canvas');
      const ctx = c.getContext('2d');
      function draw(){
        const dpr = window.devicePixelRatio || 1;
        const rect = c.getBoundingClientRect();
        c.width = rect.width * dpr; c.height = rect.height * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,rect.width,rect.height);
        const size = 24, hexW = 2 * size, hexH = Math.sqrt(3) * size, stepX = hexW * 3/4;
        ctx.strokeStyle = 'rgba(124,58,237,0.10)'; ctx.lineWidth = 1;
        for(let row=0; row*hexH < rect.height + hexH; row++){
          for(let col=0; col*stepX < rect.width + hexW; col++){
            const x = col * stepX, y = row * hexH + (col % 2 ? hexH/2 : 0);
            ctx.beginPath();
            for(let i=0;i<6;i++){ const a = 2 * Math.PI / 6 * i, px = x + size * Math.cos(a), py = y + size * Math.sin(a); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); }
            ctx.closePath(); ctx.stroke();
          }
        }
      }
      window.addEventListener('resize', draw, {passive:true});
      draw();
    })();

    // Logique du calculateur
    document.addEventListener('DOMContentLoaded', () => {
      const inputs = {
        amount: document.getElementById('loanAmount'),
        amountSlider: document.getElementById('loanAmountSlider'),
        rate: document.getElementById('interestRate'),
        rateSlider: document.getElementById('interestRateSlider'),
        term: document.getElementById('loanTerm'),
        termSlider: document.getElementById('loanTermSlider'),
      };

      const outputs = {
        monthlyPayment: document.getElementById('monthlyPaymentValue'),
        totalInterest: document.getElementById('totalInterestValue'),
        totalCost: document.getElementById('totalCostValue'),
        pieChart: document.getElementById('pieChart'),
      };
      
      const exportPdfBtn = document.getElementById('exportPdfBtn');
      const originalBtnContent = exportPdfBtn.innerHTML;

      const frLocale = 'fr-FR';
      const currencyFormat = { style: 'currency', currency: 'EUR' };

      function formatCurrency(value) {
        return value.toLocaleString(frLocale, currencyFormat);
      }

      function calculateLoan() {
        const P = parseFloat(inputs.amount.value); // Principal
        const annualRate = parseFloat(inputs.rate.value);
        const i = annualRate / 100 / 12; // Monthly interest rate
        const n = parseInt(inputs.term.value) * 12; // Number of months

        if (isNaN(P) || isNaN(annualRate) || isNaN(n) || P <= 0 || annualRate <= 0 || n <= 0) {
            outputs.monthlyPayment.textContent = '—';
            outputs.totalInterest.textContent = '—';
            outputs.totalCost.textContent = '—';
            updateChart(1, 0); // Reset chart
            exportPdfBtn.disabled = true;
            return;
        }

        const M = P * (i * Math.pow(1 + i, n)) / (Math.pow(1 + i, n) - 1); // Monthly payment
        const totalCost = M * n;
        const totalInterest = totalCost - P;

        if(isFinite(M)){
            outputs.monthlyPayment.textContent = formatCurrency(M);
            outputs.totalInterest.textContent = formatCurrency(totalInterest);
            outputs.totalCost.textContent = formatCurrency(totalCost);
            updateChart(P, totalInterest);
            exportPdfBtn.disabled = false;
        } else {
            outputs.monthlyPayment.textContent = '—';
            outputs.totalInterest.textContent = '—';
            outputs.totalCost.textContent = '—';
            updateChart(1, 0); // Reset chart
            exportPdfBtn.disabled = true;
        }
      }
      
      function updateChart(principal, interest) {
          const total = principal + interest;
          if (total <= 0) return;
          const interestPercentage = (interest / total) * 100;
          outputs.pieChart.style.background = `conic-gradient(var(--color-violet) 0% ${interestPercentage}%, var(--color-green) ${interestPercentage}% 100%)`;
      }

      function updateSliderVisual(slider) {
        const percent = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
        slider.style.setProperty('--fill-percent', `${percent}%`);
      }

      function syncInputs(source, target) {
        target.value = source.value;
        if (source.type === 'range') {
            updateSliderVisual(source);
        } else {
            // source is a number input, so target is the slider
            updateSliderVisual(target);
        }
        calculateLoan();
      }

      inputs.amount.addEventListener('input', () => syncInputs(inputs.amount, inputs.amountSlider));
      inputs.amountSlider.addEventListener('input', () => syncInputs(inputs.amountSlider, inputs.amount));
      inputs.rate.addEventListener('input', () => syncInputs(inputs.rate, inputs.rateSlider));
      inputs.rateSlider.addEventListener('input', () => syncInputs(inputs.rateSlider, inputs.rate));
      inputs.term.addEventListener('input', () => syncInputs(inputs.term, inputs.termSlider));
      inputs.termSlider.addEventListener('input', () => syncInputs(inputs.termSlider, inputs.term));
      
      async function generatePDF() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert("La librairie d'export PDF n'a pas pu être chargée. Veuillez vérifier votre connexion internet et rafraîchir la page.");
          return;
        }

        exportPdfBtn.disabled = true;
        exportPdfBtn.textContent = 'Génération...';
        
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          const primaryColor = '#7C3AED', greenColor = '#10B981', textColor = '#141417';
          const secondaryTextColor = '#6B7280', lightBgColor = '#F7F8FA', borderColor = '#E9EAF0';
          
          const principal = parseFloat(inputs.amount.value);
          const monthlyPayment = parseFloat(outputs.monthlyPayment.textContent.replace(/[^\d,]/g, '').replace(',', '.'));
          const totalInterest = parseFloat(outputs.totalInterest.textContent.replace(/[^\d,]/g, '').replace(',', '.'));
          const totalCost = parseFloat(outputs.totalCost.textContent.replace(/[^\d,]/g, '').replace(',', '.'));
          
          const formatPdfCurrency = (val) => val.toLocaleString(frLocale, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';

          doc.setFillColor(primaryColor);
          doc.rect(0, 0, 210, 25, 'F');
          doc.setFont('Helvetica', 'bold');
          doc.setFontSize(18);
          doc.setTextColor('#FFFFFF');
          doc.text("Simulation de Prêt", 105, 16, { align: 'center' });

          doc.setFontSize(10);
          doc.setFont('Helvetica', 'normal');
          doc.setTextColor(secondaryTextColor);
          doc.text(`Rapport généré le ${new Date().toLocaleDateString(frLocale)}`, 195, 35, { align: 'right' });
          
          let y = 50;
          doc.setFontSize(14);
          doc.setTextColor(textColor);
          doc.text("Votre mensualité estimée", 105, y, { align: 'center' });
          y += 10;
          doc.setFontSize(32);
          doc.setFont('Helvetica', 'bold');
          doc.setTextColor(primaryColor);
          doc.text(formatPdfCurrency(monthlyPayment), 105, y, { align: 'center' });
          y += 20;

          const col1X = 15, col2X = 110, colWidth = 85;
          const chartX = col1X + colWidth / 2 - 10, chartY = y + 30, chartRadius = 25;

          function drawPieSlice(doc, cx, cy, r, startAngle, endAngle, color) {
              doc.setFillColor(color); const steps = 100; const angleStep = (endAngle - startAngle) / steps;
              doc.moveTo(cx, cy);
              for (let i = 0; i <= steps; i++) {
                  const angle = startAngle + i * angleStep;
                  const x = cx + r * Math.cos(angle); const y = cy + r * Math.sin(angle); doc.lineTo(x, y);
              }
              doc.lineTo(cx, cy); doc.fill();
          }

          const interestPercent = totalInterest / totalCost;
          const startRad = -Math.PI / 2;
          const interestRad = interestPercent * 2 * Math.PI;
          
          drawPieSlice(doc, chartX, chartY, chartRadius, startRad, startRad + interestRad, primaryColor);
          drawPieSlice(doc, chartX, chartY, chartRadius, startRad + interestRad, startRad + 2 * Math.PI, greenColor);

          let legendY = chartY + chartRadius + 15;
          doc.setFontSize(10); doc.setTextColor(textColor); doc.setFillColor(greenColor);
          doc.rect(col1X + 5, legendY - 3.5, 4, 4, 'F');
          doc.text("Montant du capital", col1X + 12, legendY);
          doc.text(`${(100 - interestPercent * 100).toFixed(1)} %`, col1X + colWidth - 15, legendY, { align: 'right' });
          
          legendY += 8;
          doc.setFillColor(primaryColor); doc.rect(col1X + 5, legendY - 3.5, 4, 4, 'F');
          doc.text("Coût des intérêts", col1X + 12, legendY);
          doc.text(`${(interestPercent * 100).toFixed(1)} %`, col1X + colWidth - 15, legendY, { align: 'right' });

          let rightColY = y;
          doc.setFontSize(14); doc.setFont('Helvetica', 'bold'); doc.setTextColor(textColor);
          doc.text("Paramètres du prêt", col2X, rightColY);
          doc.setDrawColor(borderColor); doc.line(col2X, rightColY + 1, col2X + 45, rightColY + 1);
          rightColY += 10;

          doc.setFontSize(11); doc.setFont('Helvetica', 'normal');
          function addParam(label, value) {
              doc.setTextColor(secondaryTextColor); doc.text(label, col2X, rightColY);
              doc.setTextColor(textColor); doc.text(value, col2X + colWidth, rightColY, { align: 'right' });
              rightColY += 7;
          }
          addParam("Montant emprunté:", formatPdfCurrency(principal));
          addParam("Taux annuel:", `${parseFloat(inputs.rate.value).toLocaleString(frLocale)} %`);
          addParam("Durée:", `${parseInt(inputs.term.value)} ans`);
          
          rightColY += 10;
          
          doc.setFontSize(14); doc.setFont('Helvetica', 'bold'); doc.setTextColor(textColor);
          doc.text("Détail du coût total", col2X, rightColY);
          doc.line(col2X, rightColY + 1, col2X + 48, rightColY + 1);
          rightColY += 8;

          doc.setFillColor(lightBgColor); doc.rect(col2X, rightColY, colWidth, 8, 'F');
          doc.setFontSize(10); doc.setFont('Helvetica', 'bold');
          doc.text("Description", col2X + 3, rightColY + 5.5);
          doc.text("Montant", col2X + colWidth - 3, rightColY + 5.5, { align: 'right' });
          rightColY += 8;
          
          doc.setFont('Helvetica', 'normal');
          function addRow(label, value, isTotal = false) {
             if (isTotal) doc.setFont('Helvetica', 'bold');
             doc.text(label, col2X + 3, rightColY + 5.5);
             doc.text(formatPdfCurrency(value), col2X + colWidth - 3, rightColY + 5.5, { align: 'right' });
             if (isTotal) doc.setFont('Helvetica', 'normal');
             doc.setDrawColor(borderColor); doc.line(col2X, rightColY + 9, col2X + colWidth, rightColY + 9);
             rightColY += 9;
          }
          addRow("Montant du capital", principal);
          addRow("Coût total des intérêts", totalInterest);
          
          doc.setFillColor(lightBgColor); doc.rect(col2X, rightColY, colWidth, 10, 'F');
          addRow("Montant total remboursé", totalCost, true);

          doc.setDrawColor(borderColor); doc.line(15, 280, 195, 280);
          doc.setFontSize(9); doc.setTextColor(secondaryTextColor);
          doc.text("Rapport généré par La Ruche. Ce document est une simulation et n'a pas de valeur contractuelle.", 105, 285, { align: 'center' });

          doc.save('simulation-emprunt-laruche.pdf');
        } catch (error) {
          console.error("Erreur lors de la génération du PDF:", error);
          alert("Une erreur inattendue est survenue lors de la création du rapport PDF.");
        } finally {
          exportPdfBtn.disabled = false;
          exportPdfBtn.innerHTML = originalBtnContent;
        }
      }

      exportPdfBtn.addEventListener('click', generatePDF);

      // Initial visual setup for sliders
      document.querySelectorAll('input[type="range"]').forEach(updateSliderVisual);
      calculateLoan();
    });
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>