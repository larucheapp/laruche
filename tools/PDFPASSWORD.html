<!DOCTYPE html>
<html lang="fr" data-app="laruche" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chiffreur de PDF</title>
  <meta name="description" content="Un outil simple et sécurisé pour ajouter un mot de passe à vos fichiers PDF. Importez, chiffrez et téléchargez.">
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root{
      --color-bg:#FFFFFF;
      --color-bg-alt:#F7F8FA;
      --color-border:#E9EAF0;
      --color-text-primary:#141417;
      --color-text-secondary:#6B7280;
      --color-violet:#7C3AED;
      --color-violet-dark:#6D28D9;
      --radius-md:12px;
      --radius-lg:14px;
      --tool-max-w:480px; /* par défaut, peut être changé via body[data-size] */
    }

    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{height:100%;background-color:var(--color-bg)}
    body{
      height:100vh; overflow:hidden; display:flex; flex-direction:column;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Inter",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--color-text-primary); line-height:1.5; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body[data-size="default"]{--tool-max-w:480px}
    body[data-size="wide"]{--tool-max-w:960px}
    body[data-size="xl"]{--tool-max-w:1200px}

    #bg-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:-1}

    .app-header{
      flex-shrink:0; background:var(--color-bg-alt); border-bottom:1px solid var(--color-border);
      padding:0 24px; display:flex; align-items:center; height:70px;
    }
    .app-header a{display:inline-flex; align-items:center}
    .logo-img{height:70px; width:auto; vertical-align:middle}

    .main-content{
      flex-grow:1; display:flex; align-items:center; justify-content:center;
      padding:48px 24px; overflow-y:auto;
    }
    .tool-wrapper{display:flex; flex-direction:column; align-items:center; position:relative}
    .tool-title{
      font-size:1.75rem; font-weight:600; padding:12px 28px;
      background:linear-gradient(45deg,var(--color-violet),var(--color-violet-dark));
      color:#fff; border-radius:var(--radius-md); margin-bottom:-20px; position:relative; z-index:5;
      box-shadow:0 4px 14px -4px rgba(124,58,237,.4);
    }
    .generator-card{
      background:var(--color-bg); border:1px solid var(--color-border); border-radius:var(--radius-lg);
      padding:28px; padding-top:40px; width:100%; max-width:var(--tool-max-w);
      box-shadow:0 4px 6px -1px rgb(0 0 0 / 5%), 0 2px 4px -2px rgb(0 0 0 / 5%);
      display:flex; flex-direction:column; gap:24px;
    }
    .form-group{display:flex; flex-direction:column; gap:8px}
    .form-label{font-weight:500; color:var(--color-text-primary)}
    .form-input{
      width:100%; padding:10px 14px; border:1px solid var(--color-border); border-radius:var(--radius-md);
      font-size:1rem; color:var(--color-text-primary); background:var(--color-bg);
      transition:border-color .2s, box-shadow .2s;
    }
    .form-input:focus{outline:none; border-color:var(--color-violet); box-shadow:0 0 0 3px rgba(124,58,237,.2)}
    .actions{display:flex; justify-content:flex-end; gap:12px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      font-weight:500; padding:10px 16px; border-radius:var(--radius-md); border:none; cursor:pointer;
      transition:background-color .2s, box-shadow .2s, color .2s, border-color .2s, opacity .2s; font-size:14px;
    }
    .btn:focus-visible{outline:2px solid transparent; outline-offset:2px; box-shadow:0 0 0 3px rgba(124,58,237,.4)}
    .btn-primary{background:var(--color-violet); color:#fff; border: 1px solid transparent;}
    .btn-primary:hover:not(:disabled){background:var(--color-violet-dark)}
    .btn-secondary{ background-color: transparent; border: 1px solid var(--color-border); color: var(--color-text-primary); }
    .btn-secondary:hover:not(:disabled){border-color:var(--color-violet); color:var(--color-violet)}
    .btn:disabled{opacity:0.6; cursor:not-allowed !important}
    .status-text{font-size:14px; color:var(--color-text-secondary); text-align:center; min-height:21px}

    #upload-zone {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 32px; border: 2px dashed var(--color-border); border-radius: var(--radius-lg);
      text-align: center; cursor: pointer; transition: border-color .2s, background-color .2s;
    }
    #upload-zone.dragover { border-color: var(--color-violet); background-color: rgba(124,58,237,.05); }
    #upload-zone p { margin: 8px 0; color: var(--color-text-primary); font-weight: 500; }
    #upload-zone .upload-hint { font-size: 14px; color: var(--color-text-secondary); margin-top:0; }
    #upload-zone svg { color: var(--color-violet); margin-bottom: 12px; }

    #result-zone { display: none; flex-direction: column; gap: 20px; }
    .password-group { display: flex; flex-direction: column; gap: 8px; }
    .password-input-wrapper { position: relative; display: flex; align-items: center; }
    #password-display {
      flex-grow: 1; padding-right: 48px; font-family: 'SF Mono', 'Courier New', monospace;
      letter-spacing: 0.5px; background-color: var(--color-bg-alt);
    }
    #btn-copy {
      position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
      padding: 6px; border: none; background: transparent; color: var(--color-text-secondary); cursor: pointer;
    }
    #btn-copy:hover { color: var(--color-violet); }
    #btn-copy svg { width: 20px; height: 20px; }
    .success-message { text-align: center; font-weight: 500; color: var(--color-text-primary); font-size: 1.1rem; }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body data-size="default">
  <canvas id="bg-canvas"></canvas>

  <header class="app-header">
    <a href="index.html" aria-label="Accueil">
      <img src="logo.png" alt="Logo La Ruche" class="logo-img">
    </a>
  </header>

  <main class="main-content">
    <div class="tool-wrapper">
      <h1 class="tool-title">Chiffreur de PDF</h1>
      <div class="generator-card" role="region" aria-label="Chiffreur de PDF">
        
        <div id="upload-zone">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            <p>Glissez-déposez votre PDF ici</p>
            <p class="upload-hint">ou</p>
            <button id="btn-select-file" class="btn btn-secondary">Choisir un fichier</button>
            <input type="file" id="pdf-input" accept="application/pdf" style="display: none;">
        </div>

        <div id="result-zone">
            <p class="success-message">Votre PDF a été chiffré avec succès !</p>
            <div class="password-group">
                <label for="password-display" class="form-label">Mot de passe généré :</label>
                <div class="password-input-wrapper">
                    <input id="password-display" class="form-input" type="text" readonly>
                    <button id="btn-copy" aria-label="Copier le mot de passe">
                        <svg id="icon-copy" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        <svg id="icon-check" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </button>
                </div>
            </div>
            <div class="actions">
                <button id="btn-reset" class="btn btn-secondary">Chiffrer un autre PDF</button>
                <button id="btn-download" class="btn btn-primary">Télécharger le PDF</button>
            </div>
        </div>

      </div>
    </div>
  </main>

  <script>
    // Background hex grid — NE PAS MODIFIER (doit rester visuellement identique)
    (function(){
      const c = document.getElementById('bg-canvas');
      if (!c) return;
      const ctx = c.getContext('2d');
      function draw(){
        const dpr = window.devicePixelRatio || 1;
        const rect = c.getBoundingClientRect();
        c.width = rect.width * dpr; c.height = rect.height * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,rect.width,rect.height);

        const size = 24;
        const hexW = 2 * size;
        const hexH = Math.sqrt(3) * size;
        const stepX = hexW * 3/4;
        ctx.strokeStyle = 'rgba(124,58,237,0.10)';
        ctx.lineWidth = 1;

        for(let row=0; row*hexH < rect.height + hexH; row++){
          for(let col=0; col*stepX < rect.width + hexW; col++){
            const x = col * stepX;
            const y = row * hexH + (col % 2 ? hexH/2 : 0);
            ctx.beginPath();
            for(let i=0;i<6;i++){
              const a = 2 * Math.PI / 6 * i;
              const px = x + size * Math.cos(a);
              const py = y + size * Math.sin(a);
              if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
            }
            ctx.closePath(); ctx.stroke();
          }
        }
      }
      window.addEventListener('resize', draw, {passive:true});
      draw();
    })();
  </script>
  <script>
    // PDF Encryptor App Logic
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof PDFLib === 'undefined') {
        console.error("La bibliothèque pdf-lib n'a pas pu être chargée.");
        return;
      }
      const { PDFDocument } = PDFLib;

      const uploadZone = document.getElementById('upload-zone');
      const resultZone = document.getElementById('result-zone');
      const pdfInput = document.getElementById('pdf-input');
      const btnSelectFile = document.getElementById('btn-select-file');
      
      const passwordDisplay = document.getElementById('password-display');
      const btnCopy = document.getElementById('btn-copy');
      const iconCopy = document.getElementById('icon-copy');
      const iconCheck = document.getElementById('icon-check');

      const btnDownload = document.getElementById('btn-download');
      const btnReset = document.getElementById('btn-reset');

      let encryptedPdfBytes = null;
      let originalFileName = '';

      // --- Upload Logic ---
      uploadZone.addEventListener('click', () => pdfInput.click());
      uploadZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadZone.classList.add('dragover');
      });
      uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
      uploadZone.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadZone.classList.remove('dragover');
          if (e.dataTransfer.files.length) {
              const file = e.dataTransfer.files[0];
              if (file.type === 'application/pdf') {
                  handleFile(file);
              }
          }
      });

      btnSelectFile.addEventListener('click', (e) => {
          e.stopPropagation();
          pdfInput.click();
      });

      pdfInput.addEventListener('change', (e) => {
          if (e.target.files.length) {
              handleFile(e.target.files[0]);
          }
      });

      const handleFile = (file) => {
          originalFileName = file.name.replace(/\.pdf$/i, '');
          const fileReader = new FileReader();
          fileReader.onload = async (event) => {
              try {
                  await encryptPdf(event.target.result);
              } catch (error) {
                  console.error("Erreur lors du chiffrement:", error);
                  alert("Une erreur est survenue lors du traitement du PDF. Le fichier est peut-être corrompu.");
              }
          };
          fileReader.readAsArrayBuffer(file);
      };
      
      // --- Encryption and UI Logic ---
      const generatePassword = (length = 16) => {
          const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
          let password = '';
          const crypto = window.crypto || window.msCrypto;
          const values = new Uint32Array(length);
          crypto.getRandomValues(values);
          for (let i = 0; i < length; i++) {
              password += charset[values[i] % charset.length];
          }
          return password;
      };

      const encryptPdf = async (pdfData) => {
          const generatedPassword = generatePassword();
          const pdfDoc = await PDFDocument.load(pdfData);
          
          encryptedPdfBytes = await pdfDoc.save({
              userPassword: generatedPassword,
              ownerPassword: generatedPassword,
              permissions: {} // CORRECTIF : Utiliser un objet vide au lieu d'un tableau
          });
          
          passwordDisplay.value = generatedPassword;
          uploadZone.style.display = 'none';
          resultZone.style.display = 'flex';
      };

      btnDownload.addEventListener('click', () => {
          if (!encryptedPdfBytes) return;
          const blob = new Blob([encryptedPdfBytes], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${originalFileName}_chiffre.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
      });

      btnCopy.addEventListener('click', () => {
          navigator.clipboard.writeText(passwordDisplay.value).then(() => {
              iconCopy.style.display = 'none';
              iconCheck.style.display = 'inline';
              setTimeout(() => {
                  iconCopy.style.display = 'inline';
                  iconCheck.style.display = 'none';
              }, 2000);
          });
      });

      btnReset.addEventListener('click', () => {
          encryptedPdfBytes = null;
          originalFileName = '';
          pdfInput.value = '';
          passwordDisplay.value = '';
          resultZone.style.display = 'none';
          uploadZone.style.display = 'flex';
      });
    });
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>